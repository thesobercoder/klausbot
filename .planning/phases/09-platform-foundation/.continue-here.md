---
phase: 09-platform-foundation
task: post-verification-fixes
total_tasks: N/A
status: in_progress
last_updated: 2026-01-31T14:15:00Z
---

<current_state>
Phase 9 plans (3/3) executed and verified. Currently fixing post-verification issues found during manual testing:
- Removing DATA_DIR from codebase (user requested full removal)
- Work is partially complete - install.ts still has dataDir references
</current_state>

<completed_work>

**Phase 9 execution:**
- 09-01: Platform detection module ✓
- 09-02: Capability checking with startup checklist ✓
- 09-03: 12-factor config separation ✓

**Post-verification fixes (this session):**
- `claude --version` instead of non-existent `claude auth status`
- Node `fs.existsSync` for PATH check instead of shell `which`
- Logging moved after capability validation
- Removed redundant blank line before header
- Lazy OpenAI client in `conversations.ts` (was crashing on import)
- Dynamic import of telegram module after validation
- `setTimeout(100ms)` instead of `setImmediate` for pino flush
- Removed tsx dependency (different runtime behavior caused issues)

**DATA_DIR removal (in progress):**
- Removed from config/schema.ts ✓
- Updated daemon/index.ts to use KLAUSBOT_HOME ✓
- Updated daemon/gateway.ts to use KLAUSBOT_HOME ✓
- Updated index.ts pairing commands to use KLAUSBOT_HOME ✓
- Updated index.ts help text ✓
- Updated install.ts generateEnvContent ✓
- Remaining: install.ts still has dataDir prompts for systemd/docker/dev modes
</completed_work>

<remaining_work>

**DATA_DIR removal (install.ts):**
- Lines 223, 263: systemd install references dataDir (needs removal or use ~/.klausbot)
- Lines 282-308: docker install uses dataDir (remove prompt, use default)
- Lines 323-340: dev install uses dataDir (remove prompt, use default)
- Service file template references ReadWritePaths for dataDir

**Note:** pairing/store.ts, pairing/flow.ts, daemon/queue.ts have `dataDir` as parameter names - these are fine to keep since they just accept a path.
</remaining_work>

<decisions_made>

- Remove DATA_DIR entirely from codebase - everything uses ~/.klausbot/ now
- Use `setTimeout(100ms)` for graceful exit instead of `setImmediate` - works with both tsx and built version
- Remove tsx dependency - caused different runtime behavior with pino flush
- `claude --version` for capability check (not auth check) - doctor command will do full auth test
- Dynamic import telegram module after validation - prevents crash when TELEGRAM_BOT_TOKEN missing
</decisions_made>

<blockers>
None - just need to finish install.ts cleanup
</blockers>

<context>
User wants DATA_DIR completely removed from codebase. Everything now uses ~/.klausbot/ as the home directory. The install wizard in install.ts still prompts for data directory in systemd, docker, and dev modes - these prompts should be removed since the app no longer uses a configurable data directory.

Approach: Remove dataDir prompts from install.ts, simplify to just ask for bot token. The service file may need adjustment for ReadWritePaths.
</context>

<next_action>
1. Finish cleaning install.ts - remove dataDir prompts from systemd/docker/dev handlers
2. Update service file template to use ~/.klausbot instead of configurable path
3. Commit all DATA_DIR removal changes
4. Build and verify everything works
5. Then ready for Phase 10 (Doctor Command)
</next_action>

<uncommitted_files>
- .env.example
- package-lock.json
- src/cli/install.ts
- src/config/schema.ts
- src/daemon/gateway.ts
- src/daemon/index.ts
- src/index.ts
</uncommitted_files>
