---
phase: 12-heartbeat-system
plan: 03
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - src/heartbeat/notes.ts
  - src/heartbeat/index.ts
  - src/daemon/gateway.ts
autonomous: true

must_haves:
  truths:
    - "User can say 'remind me to check X' and trigger note collection"
    - "Claude interprets intent and adds cleaned note to HEARTBEAT.md"
    - "User receives brief confirmation 'Added to heartbeat reminders'"
    - "Note collection skipped during bootstrap mode"
  artifacts:
    - path: "src/heartbeat/notes.ts"
      provides: "shouldCollectNote, getNoteCollectionInstructions functions"
      exports: ["shouldCollectNote", "getNoteCollectionInstructions"]
    - path: "src/heartbeat/index.ts"
      provides: "Re-exports notes functions"
      contains: "shouldCollectNote"
  key_links:
    - from: "src/daemon/gateway.ts"
      to: "src/heartbeat/notes.ts"
      via: "shouldCollectNote check in processMessage"
      pattern: "shouldCollectNote"
    - from: "src/daemon/gateway.ts"
      to: "additionalInstructions"
      via: "getNoteCollectionInstructions appended"
      pattern: "getNoteCollectionInstructions"
---

<objective>
Enable users to add reminders to HEARTBEAT.md via natural language in conversation.

Purpose: Users can say "remind me to X" or "don't forget Y" and Claude interprets + stores a cleaned note.
Output: Trigger phrase detection + gateway integration for note collection flow.
</objective>

<execution_context>
@/home/soham/.claude/get-shit-done/workflows/execute-plan.md
@/home/soham/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-heartbeat-system/12-CONTEXT.md
@.planning/phases/12-heartbeat-system/12-01-SUMMARY.md

# Gateway for integration

@src/daemon/gateway.ts

# Executor for heartbeat path

@src/heartbeat/executor.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create notes module with trigger detection</name>
  <files>src/heartbeat/notes.ts</files>
  <action>
Create notes.ts with trigger phrase detection and instruction generator.

```typescript
/**
 * Heartbeat note collection - detect trigger phrases and generate instructions
 * Claude interprets user intent and stores cleaned notes to HEARTBEAT.md
 */

import { getHeartbeatPath } from "./executor.js";

/**
 * Trigger phrases that indicate user wants to add a heartbeat reminder
 * Case-insensitive matching
 */
const TRIGGER_PHRASES = [
  /\bremind me\b/i,
  /\bdon'?t forget\b/i,
  /\bcheck on\b/i,
  /\bremember to\b/i,
  /\bheartbeat:/i,
  /\badd.*reminder\b/i,
  /\bkeep track of\b/i,
];

/**
 * Check if message text contains a heartbeat note trigger phrase
 *
 * @param text - User message text
 * @returns true if message should trigger note collection
 */
export function shouldCollectNote(text: string): boolean {
  return TRIGGER_PHRASES.some((pattern) => pattern.test(text));
}

/**
 * Generate additional instructions for Claude to collect and store a heartbeat note
 * Claude interprets user intent and stores a cleaned/structured note (not verbatim)
 *
 * @param text - Original user message
 * @returns Instructions to append to system prompt
 */
export function getNoteCollectionInstructions(text: string): string {
  const heartbeatPath = getHeartbeatPath();

  return `<heartbeat-note-request>
The user is asking to add something to their heartbeat reminders.
Their message: "${text}"

Instructions:
1. Interpret the user's intent (what do they want to remember/check?)
2. Clean and structure the note appropriately
3. Add the note to ${heartbeatPath} under "## Active Items"
4. Include any expiry dates if the user mentioned timing (e.g., "by Friday" â†’ [expires: YYYY-MM-DD])
5. Respond with a brief confirmation like "Added to heartbeat reminders"

HEARTBEAT.md format:
- Use markdown checkboxes: "- [ ] Item description"
- Add optional expiry: "- [ ] Item [expires: YYYY-MM-DD]"
- Keep notes concise and actionable

Do NOT store the user's message verbatim - interpret and clean it.
</heartbeat-note-request>`;
}
```

Key design decisions (per CONTEXT.md):

- Trigger phrases at Claude's discretion - included common patterns
- Claude interprets intent, stores cleaned note (not verbatim)
- Brief confirmation response
  </action>
  <verify>
  `ls src/heartbeat/notes.ts` confirms file exists.
  `grep "shouldCollectNote" src/heartbeat/notes.ts` shows export.
  </verify>
  <done>
  Notes module with TRIGGER_PHRASES array, shouldCollectNote() for detection, getNoteCollectionInstructions() for Claude prompt injection.
  </done>
  </task>

<task type="auto">
  <name>Task 2: Add notes exports to heartbeat index</name>
  <files>src/heartbeat/index.ts</files>
  <action>
Update index.ts to export notes functions:

Add to existing exports:

```typescript
export { shouldCollectNote, getNoteCollectionInstructions } from "./notes.js";
```

Full file should be:

```typescript
/**
 * Heartbeat module - periodic awareness system
 */

export { startHeartbeat, stopHeartbeat } from "./scheduler.js";
export {
  executeHeartbeat,
  getHeartbeatPath,
  type HeartbeatResult,
} from "./executor.js";
export { shouldCollectNote, getNoteCollectionInstructions } from "./notes.js";
```

  </action>
  <verify>
`grep "shouldCollectNote" src/heartbeat/index.ts` shows export line.
  </verify>
  <done>
Heartbeat index exports shouldCollectNote and getNoteCollectionInstructions.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate note collection into gateway processMessage</name>
  <files>src/daemon/gateway.ts</files>
  <action>
Update gateway.ts to detect note triggers and inject instructions.

1. Add import (update existing heartbeat import):

```typescript
import {
  startHeartbeat,
  stopHeartbeat,
  shouldCollectNote,
  getNoteCollectionInstructions,
} from "../heartbeat/index.js";
```

2. In processMessage(), add note collection check BEFORE building additionalInstructions.

Find this section (around line 607-625):

```typescript
// Build additional instructions
// Always include chatId context for cron management
const chatIdContext = `<session-context>
Current chat ID: ${msg.chatId}
Use this chatId when creating cron jobs.
</session-context>`;

const additionalInstructions = isBootstrap
  ? chatIdContext + "\n\n" + BOOTSTRAP_INSTRUCTIONS
  : chatIdContext;
```

Replace with:

```typescript
// Build additional instructions
// Always include chatId context for cron management
const chatIdContext = `<session-context>
Current chat ID: ${msg.chatId}
Use this chatId when creating cron jobs.
</session-context>`;

// Check for heartbeat note collection trigger (skip during bootstrap)
let noteInstructions = "";
if (!isBootstrap && shouldCollectNote(effectiveText)) {
  noteInstructions = "\n\n" + getNoteCollectionInstructions(effectiveText);
  log.info({ chatId: msg.chatId }, "Heartbeat note collection triggered");
}

const additionalInstructions = isBootstrap
  ? chatIdContext + "\n\n" + BOOTSTRAP_INSTRUCTIONS
  : chatIdContext + noteInstructions;
```

Key behavior (per CONTEXT.md):

- Skip note collection during bootstrap (identity files must exist first)
- Log when note collection is triggered
- Instructions appended to additionalInstructions (Claude interprets and stores)
  </action>
  <verify>
  `grep "shouldCollectNote" src/daemon/gateway.ts` shows both import and usage.
  `grep "noteInstructions" src/daemon/gateway.ts` shows the logic.
  </verify>
  <done>
- Gateway imports shouldCollectNote and getNoteCollectionInstructions
- processMessage checks for trigger phrases (skips during bootstrap)
- Matching messages get note collection instructions appended
- Logging indicates when note collection is triggered
  </done>
  </task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Notes module: `ls src/heartbeat/notes.ts`
3. Gateway integration: `grep -E "(shouldCollectNote|noteInstructions)" src/daemon/gateway.ts`
4. Exports work: `grep "shouldCollectNote" src/heartbeat/index.ts`
</verification>

<success_criteria>

- [ ] notes.ts exports shouldCollectNote() and getNoteCollectionInstructions()
- [ ] shouldCollectNote() returns true for "remind me to X", "don't forget Y", etc.
- [ ] getNoteCollectionInstructions() generates XML prompt with heartbeat file path
- [ ] Gateway imports and uses shouldCollectNote in processMessage
- [ ] Note collection skipped during bootstrap mode (isBootstrap check)
- [ ] TypeScript compiles without errors
      </success_criteria>

<output>
After completion, create `.planning/phases/12-heartbeat-system/12-03-SUMMARY.md`
</output>
