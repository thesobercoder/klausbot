---
phase: 07.1-memory-search-mcp
plan: 02
subsystem: mcp-server
tags: [sqlite-vec, mcp, semantic-search, knn, embeddings]

# Dependency graph
requires:
  - phase: 07.1-01
    provides: SQLite database with vec_embeddings table
provides:
  - semanticSearch() with sqlite-vec KNN queries
  - search_memories MCP tool for Claude
  - daysBack filtering for time-scoped search
affects: [claude-memory-access, future-memory-features]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "sqlite-vec KNN: WHERE embedding MATCH ? AND k = ?"
    - "Float32Array directly for query vectors"
    - "Distance to similarity: 1 / (1 + distance)"

key-files:
  created:
    - src/mcp-server/tools/memory.ts
  modified:
    - src/memory/search.ts
    - src/mcp-server/index.ts

key-decisions:
  - "Use k = ? constraint for sqlite-vec KNN, not LIMIT"
  - "Float32Array directly (not .buffer) for query embedding"
  - "Score as 1/(1+distance) for intuitive percentage display"
  - "Optional daysBack parameter for time-scoped search"

patterns-established:
  - "MCP tool registration pattern: registerXTools(server)"
  - "Memory tool response format: numbered list with score and date"

# Metrics
duration: 2min
completed: 2026-01-30
---

# Phase 07.1 Plan 02: MCP Memory Search Tool Summary

**search_memories MCP tool exposing semantic search to Claude via sqlite-vec KNN**

## Performance

- **Duration:** 2 min
- **Started:** 2026-01-30T17:48:51Z
- **Completed:** 2026-01-30T17:50:57Z
- **Tasks:** 3
- **Files modified:** 3

## Accomplishments

- Rewrote search.ts to use sqlite-vec KNN queries instead of in-memory cosine similarity
- Created search_memories MCP tool with query, limit, days_back parameters
- Integrated memory tools into MCP server alongside cron tools
- Verified no regressions in existing functionality

## Task Commits

Each task was committed atomically:

1. **Task 1: Update search.ts to use sqlite-vec KNN** - `29334a2` (feat)
2. **Task 2: Add search_memories MCP tool** - `95ff21f` (feat)
3. **Task 3: End-to-end verification** - (verification only, no commit)

## Files Created/Modified

- `src/memory/search.ts` - Rewritten with sqlite-vec KNN queries, daysBack filter
- `src/mcp-server/tools/memory.ts` - New MCP tool with semantic search
- `src/mcp-server/index.ts` - Imports and registers memory tools

## Key Implementation Details

**sqlite-vec KNN Query:**

```sql
SELECT e.text, e.source, e.timestamp, v.distance
FROM vec_embeddings v
INNER JOIN embeddings e ON e.id = v.rowid
WHERE v.embedding MATCH ?
  AND v.k = ?
ORDER BY v.distance
```

**MCP Tool Parameters:**
| Parameter | Type | Description |
|-----------|------|-------------|
| query | string | Natural language search query |
| limit | number (optional) | Max results (default: 5) |
| days_back | number (optional) | Filter to last N days |

**Response Format:**

```
Found 3 relevant memories:

[1] (85% match, 1/29/2026)
Discussed project deadlines...

[2] (72% match, 1/28/2026)
Mentioned timeline concerns...
```

## Decisions Made

- **k = ? constraint:** sqlite-vec requires `k = ?` in WHERE clause, not LIMIT
- **Float32Array directly:** No need for .buffer - sqlite-vec accepts typed arrays
- **Score conversion:** 1/(1+distance) gives intuitive 0-1 similarity score
- **daysBack filter:** Applied in SQL via timestamp >= cutoff.toISOString()

## Deviations from Plan

None - plan executed exactly as written.

## Verification Results

| Check                   | Status |
| ----------------------- | ------ |
| npm run build           | PASS   |
| MCP server starts       | PASS   |
| Gateway starts cleanly  | PASS   |
| Cron CLI works          | PASS   |
| Memory tools registered | PASS   |

## User Setup Required

None - tool automatically available when klausbot runs as MCP server.

## Next Phase Readiness

Phase 7.1 complete. Claude can now search past conversations via `search_memories` MCP tool.

**Usage via Claude CLI:**

- Tool auto-discovered when klausbot runs as MCP server
- Invoke: `search_memories` with query, optional limit/days_back
- Returns formatted results with match scores and dates

---

_Phase: 07.1-memory-search-mcp_
_Completed: 2026-01-30_
