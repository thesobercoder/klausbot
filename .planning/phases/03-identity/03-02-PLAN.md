---
phase: 03-identity
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/daemon/spawner.ts
  - src/daemon/gateway.ts
  - src/memory/context.ts
autonomous: true

must_haves:
  truths:
    - "First message from paired user triggers bootstrap if identity files missing"
    - "Bootstrap APPENDS instructions to normal system prompt (does not replace)"
    - "After bootstrap completes, subsequent messages use normal system prompt only"
    - "Identity cache invalidated after every Claude response"
    - "Claude knows SOUL.md is locked, IDENTITY.md and USER.md are mutable"
  artifacts:
    - path: "src/daemon/spawner.ts"
      provides: "additionalInstructions option for bootstrap mode"
      exports: ["SpawnerOptions.additionalInstructions"]
    - path: "src/daemon/gateway.ts"
      provides: "Bootstrap detection and routing in processMessage"
      contains: "needsBootstrap"
    - path: "src/memory/context.ts"
      provides: "Identity update instructions in retrieval instructions"
      contains: "IDENTITY.md: MUTABLE"
  key_links:
    - from: "src/daemon/gateway.ts"
      to: "src/bootstrap/index.ts"
      via: "needsBootstrap import"
      pattern: "import.*needsBootstrap.*from.*bootstrap"
    - from: "src/daemon/gateway.ts"
      to: "src/daemon/spawner.ts"
      via: "additionalInstructions option"
      pattern: "additionalInstructions.*BOOTSTRAP"
    - from: "src/daemon/gateway.ts"
      to: "src/memory/index.ts"
      via: "invalidateIdentityCache call"
      pattern: "invalidateIdentityCache\\(\\)"
---

<objective>
Wire bootstrap detection into gateway and add identity update instructions.

Purpose: Make gateway detect bootstrap-needed state and APPEND bootstrap instructions to normal system prompt. Enable instant identity updates with clear mutability rules for Claude.
Output: Gateway handles bootstrap flow additively, spawner accepts additional instructions, Claude knows identity file rules.
</objective>

<execution_context>
@/home/soham/.claude/get-shit-done/workflows/execute-plan.md
@/home/soham/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-identity/03-CONTEXT.md
@.planning/phases/03-identity/03-RESEARCH.md
@.planning/phases/03-identity/03-01-SUMMARY.md

# Key files to modify

@src/daemon/gateway.ts
@src/daemon/spawner.ts
@src/memory/context.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Spawner additional instructions support</name>
  <files>src/daemon/spawner.ts</files>
  <action>
Modify src/daemon/spawner.ts:

1. Add additionalInstructions to SpawnerOptions interface:

   ```typescript
   export interface SpawnerOptions {
     timeout?: number;
     model?: string;
     additionalInstructions?: string; // Appended to system prompt (for bootstrap mode)
   }
   ```

2. In queryClaudeCode(), APPEND additional instructions to system prompt if provided:
   ```typescript
   let systemPrompt = buildSystemPrompt();
   if (options.additionalInstructions) {
     systemPrompt += "\n\n" + options.additionalInstructions;
   }
   ```

IMPORTANT: This is ADDITIVE - the normal system prompt (identity files, retrieval instructions, etc.) remains intact. Bootstrap instructions are appended, not replacing.
</action>
<verify>
npx tsc --noEmit && echo "TypeScript compiles"
grep -q "additionalInstructions" src/daemon/spawner.ts
</verify>
<done>
SpawnerOptions.additionalInstructions available.
queryClaudeCode appends additional instructions to buildSystemPrompt() output.
</done>
</task>

<task type="auto">
  <name>Task 2: Gateway bootstrap routing and cache invalidation</name>
  <files>src/daemon/gateway.ts, src/memory/context.ts</files>
  <action>
Modify src/daemon/gateway.ts:

1. Add imports at top:

   ```typescript
   import {
     needsBootstrap,
     BOOTSTRAP_INSTRUCTIONS,
   } from "../bootstrap/index.js";
   import { invalidateIdentityCache } from "../memory/index.js";
   ```

2. In processMessage(), BEFORE queryClaudeCode call (after logUserMessage, around line 220):

   ```typescript
   // Check if bootstrap needed BEFORE processing
   const isBootstrap = needsBootstrap();
   ```

3. Pass additionalInstructions to queryClaudeCode (bootstrap instructions appended to normal prompt):

   ```typescript
   const response = await queryClaudeCode(msg.text, {
     additionalInstructions: isBootstrap ? BOOTSTRAP_INSTRUCTIONS : undefined,
   });
   ```

4. AFTER successful response, invalidate cache. Place AFTER logAssistantMessage() (line 239) and BEFORE splitAndSend() (line 243):

   ```typescript
   // Log assistant response AFTER success
   logAssistantMessage(response.result);

   // Invalidate identity cache after Claude response
   // (Claude may have updated identity files during session)
   invalidateIdentityCache();

   // Create a minimal context-like object for sendLongMessage
   // sendLongMessage expects a context with reply method
   const messages = await splitAndSend(msg.chatId, response.result);
   ```

   This placement ensures:
   - Cache invalidated only on success (inside !response.is_error block)
   - Happens after logging but before sending response
   - Next message will use fresh identity from any files Claude modified

Modify src/memory/context.ts getRetrievalInstructions():

5. Add identity update instructions section (append before closing </memory-instructions>):

   ```markdown
   ## Identity Updates

   ### File Mutability Rules

   - SOUL.md: LOCKED - Never modify after creation. Core values are permanent.
   - IDENTITY.md: MUTABLE - Update when user asks to change name, style, personality.
   - USER.md: MUTABLE - You update automatically when learning preferences.

   ### Natural Language Updates

   When user says things like:

   - "Be more casual" -> Update IDENTITY.md style section
   - "Call yourself Bob" -> Update IDENTITY.md name
   - "Remember I prefer..." -> Update USER.md preferences
   - "Change your boundaries" -> Soft deflect, don't modify SOUL.md

   After updating IDENTITY.md or USER.md, your next response should reflect the change.

   ### Soft Boundary Deflection

   If asked to modify SOUL.md or violate boundaries:

   - "That's not really my thing, but I'd love to help with..."
   - "My core values are set, but I'm happy to adjust my communication style!"
   - "I'll pass on that one. What else can I do for you?"
   ```

     </action>
     <verify>
   npx tsc --noEmit && echo "TypeScript compiles"
   npm run build
   grep -q "needsBootstrap" src/daemon/gateway.ts
   grep -q "invalidateIdentityCache" src/daemon/gateway.ts
   grep -q "additionalInstructions" src/daemon/gateway.ts
   grep -q "SOUL.md: LOCKED" src/memory/context.ts

# Verify invalidateIdentityCache is in success block (between logAssistantMessage and splitAndSend)

grep -A3 "logAssistantMessage" src/daemon/gateway.ts | grep -q "invalidateIdentityCache"
</verify>
<done>
Gateway detects bootstrap state and appends BOOTSTRAP_INSTRUCTIONS to normal prompt.
Normal system prompt preserved - bootstrap is additive.
Cache invalidated after every Claude response.
Retrieval instructions include identity update rules.
</done>
</task>

</tasks>

<verification>
- npm run build succeeds
- Gateway imports bootstrap module functions
- Gateway uses additionalInstructions (not override) for bootstrap
- Gateway calls invalidateIdentityCache() after responses
- Retrieval instructions include identity mutability rules
</verification>

<success_criteria>

1. SpawnerOptions includes additionalInstructions (not override)
2. Gateway checks needsBootstrap() before processing
3. Bootstrap APPENDS instructions to normal system prompt
4. Normal system prompt (identity, retrieval instructions) preserved during bootstrap
5. Cache invalidated after every Claude response
6. Claude knows SOUL.md locked, IDENTITY.md/USER.md mutable
7. Soft deflection examples included for boundary violations
   </success_criteria>

<output>
After completion, create `.planning/phases/03-identity/03-02-SUMMARY.md`
</output>
