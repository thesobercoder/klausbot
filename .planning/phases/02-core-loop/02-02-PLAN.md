---
phase: 02-core-loop
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/memory/context.ts
  - src/memory/index.ts
  - src/daemon/spawner.ts
autonomous: true

must_haves:
  truths:
    - "Claude Code spawned with cwd=~/.klausbot/"
    - "Identity files (SOUL.md, IDENTITY.md, USER.md) injected via --append-system-prompt"
    - "Retrieval instructions tell Claude where conversations live and how to search"
  artifacts:
    - path: "src/memory/context.ts"
      provides: "System prompt builder with identity + instructions"
      exports: ["buildSystemPrompt", "loadIdentity", "getRetrievalInstructions"]
    - path: "src/daemon/spawner.ts"
      provides: "Claude Code spawner with cwd and system prompt"
      exports: ["queryClaudeCode"]
  key_links:
    - from: "src/daemon/spawner.ts"
      to: "src/memory/context.ts"
      via: "import buildSystemPrompt"
      pattern: "import.*buildSystemPrompt"
    - from: "src/daemon/spawner.ts"
      to: "spawn options"
      via: "cwd: KLAUSBOT_HOME"
      pattern: "cwd.*KLAUSBOT_HOME"
    - from: "src/daemon/spawner.ts"
      to: "claude CLI"
      via: "--append-system-prompt"
      pattern: "--append-system-prompt"
---

<objective>
Create context builder and update spawner to inject identity + retrieval instructions via --append-system-prompt, spawning with cwd=~/.klausbot/.

Purpose: Enable Claude to read identity files and search conversations agentically.
Output: Context-aware spawner that bootstraps Claude sessions with memory access.
</objective>

<execution_context>
@/home/soham/.claude/get-shit-done/workflows/execute-plan.md
@/home/soham/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-core-loop/02-CONTEXT.md
@.planning/phases/02-core-loop/02-RESEARCH.md
@src/daemon/spawner.ts
@src/memory/home.ts (from 02-01)
@src/memory/identity.ts (from 02-01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Context builder module</name>
  <files>src/memory/context.ts, src/memory/index.ts</files>
  <action>
Create src/memory/context.ts:

```typescript
// Cache identity content at startup to avoid blocking I/O per request
let identityCache: string | null = null;

export function loadIdentity(): string
```
- Read SOUL.md, IDENTITY.md, USER.md from identity dir
- Wrap each in XML tags: `<SOUL.md>\n{content}\n</SOUL.md>`
- Cache result in module-level variable
- Return cached value on subsequent calls
- Return empty string if files don't exist (graceful degradation)

```typescript
export function getRetrievalInstructions(): string
```
- Build instructions block wrapped in `<memory-instructions>` tags
- Include:
  - Working directory: ~/.klausbot/
  - Files available: conversations/{date}.md, identity/USER.md
  - Retrieval workflow: read today's conversation, use Grep for search, [!important] markers
  - Preference learning: update USER.md when user states preference
- Use local date: new Date().toLocaleDateString('en-CA')

```typescript
export function buildSystemPrompt(): string
```
- Return loadIdentity() + '\n\n' + getRetrievalInstructions()

Update src/memory/index.ts to re-export from ./context.js
  </action>
  <verify>
```bash
cd /Users/soham/Documents/GitHub/clawdbot && npm run build
grep "buildSystemPrompt" dist/memory/context.js
grep "buildSystemPrompt" dist/memory/index.js
```
  </verify>
  <done>context.ts exports buildSystemPrompt that combines identity files + retrieval instructions</done>
</task>

<task type="auto">
  <name>Task 2: Update spawner with cwd and system prompt</name>
  <files>src/daemon/spawner.ts</files>
  <action>
Modify src/daemon/spawner.ts:

1. Add imports at top:
```typescript
import { KLAUSBOT_HOME, buildSystemPrompt } from '../memory/index.js';
```

2. In queryClaudeCode function, update spawn call:
- Add `cwd: KLAUSBOT_HOME` to spawn options (third argument)
- Add `--append-system-prompt` with buildSystemPrompt() to args array
- Keep existing args: ['--dangerously-skip-permissions', '-p', prompt, '--output-format', 'json']
- Insert system prompt args: ['--append-system-prompt', systemPrompt, ...]

Order of args:
```typescript
const systemPrompt = buildSystemPrompt();
const args = [
  '--dangerously-skip-permissions',
  '-p', prompt,
  '--output-format', 'json',
  '--append-system-prompt', systemPrompt,
];
```

Spawn options:
```typescript
const claude = spawn('claude', args, {
  stdio: ['inherit', 'pipe', 'pipe'],
  cwd: KLAUSBOT_HOME,  // NEW: Working directory for agentic file access
  env: process.env,
});
```

3. Log the cwd in spawn info:
```typescript
logger.info(
  { prompt: truncatedPrompt, timeout, model: options.model, cwd: KLAUSBOT_HOME },
  'Spawning Claude Code'
);
```
  </action>
  <verify>
```bash
cd /Users/soham/Documents/GitHub/clawdbot && npm run build

# Verify cwd in spawn
grep -A5 "spawn('claude'" dist/daemon/spawner.js | grep "cwd"

# Verify --append-system-prompt in args
grep "append-system-prompt" dist/daemon/spawner.js
```
  </verify>
  <done>spawner.ts spawns Claude with cwd=~/.klausbot/ and --append-system-prompt for identity injection</done>
</task>

</tasks>

<verification>
```bash
cd /Users/soham/Documents/GitHub/clawdbot

# Full build succeeds
npm run build

# Type check passes
npx tsc --noEmit

# Verify key patterns
grep -l "KLAUSBOT_HOME" dist/daemon/spawner.js
grep -l "append-system-prompt" dist/daemon/spawner.js
grep -l "buildSystemPrompt" dist/daemon/spawner.js
```
</verification>

<success_criteria>
- context.ts builds system prompt from identity files + retrieval instructions
- spawner.ts passes cwd=~/.klausbot/ to spawn()
- spawner.ts includes --append-system-prompt in args
- Build passes with no TypeScript errors
- Identity cache prevents re-reading files on every request
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-loop/02-02-SUMMARY.md`
</output>
