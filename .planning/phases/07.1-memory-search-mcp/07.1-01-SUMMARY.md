---
phase: 07.1-memory-search-mcp
plan: 01
subsystem: database
tags: [sqlite, sqlite-vec, better-sqlite3, embeddings, vector-storage]

# Dependency graph
requires:
  - phase: 02-core-loop
    provides: embeddings.ts with JSON file storage
provides:
  - SQLite database module with sqlite-vec extension
  - Lazy-initialized database connection with WAL mode
  - embeddings.ts writing to SQLite instead of JSON
  - JSON to SQLite migration script (idempotent)
  - Gateway startup migration call
affects: [07.1-02-vector-search, memory-search-mcp]

# Tech tracking
tech-stack:
  added: [better-sqlite3, sqlite-vec, "@types/better-sqlite3"]
  patterns:
    [
      BigInt for vec0 rowid,
      Float32Array for vector data,
      sqliteVec.load() for binding,
    ]

key-files:
  created:
    - src/memory/db.ts
    - src/memory/migrate.ts
  modified:
    - src/memory/embeddings.ts
    - src/memory/index.ts
    - src/daemon/gateway.ts
    - package.json

key-decisions:
  - "Use sqliteVec.load(db) instead of db.loadExtension() for proper parameter binding"
  - "BigInt(rowid) required for vec0 virtual table inserts"
  - "Float32Array directly (not .buffer) for vector data"
  - "initializeEmbeddings() kept as no-op for API compatibility"

patterns-established:
  - "sqlite-vec binding: BigInt for rowid, Float32Array for vectors"
  - "Database lazy initialization: getDb() creates on first call"
  - "Migration idempotence: check for JSON file, no-op if migrated"

# Metrics
duration: 12min
completed: 2026-01-30
---

# Phase 07.1 Plan 01: SQLite Vector Storage Summary

**SQLite database with sqlite-vec extension replacing JSON file storage for embeddings**

## Performance

- **Duration:** 12 min
- **Started:** 2026-01-30T17:34:00Z
- **Completed:** 2026-01-30T17:46:22Z
- **Tasks:** 3
- **Files modified:** 6

## Accomplishments

- SQLite database module with lazy initialization and WAL mode
- embeddings.ts now writes directly to SQLite with vec0 virtual table
- Migration script converts legacy embeddings.json to SQLite (idempotent)
- Gateway startup calls migration, shutdown closes database

## Task Commits

Each task was committed atomically:

1. **Task 1: Install dependencies and create database module** - `3b3b977` (feat)
2. **Task 2: Update embeddings.ts for SQLite storage and create migration** - `3e374ed` (feat)
3. **Task 3: Wire migration into startup and update module exports** - `2f03dc1` (feat)

## Files Created/Modified

- `src/memory/db.ts` - Database module with lazy init, WAL mode, vec0 schema
- `src/memory/migrate.ts` - JSON to SQLite migration (idempotent, transactional)
- `src/memory/embeddings.ts` - Updated to write to SQLite, removed JSON functions
- `src/memory/index.ts` - Exports getDb, closeDb, migrateEmbeddings
- `src/daemon/gateway.ts` - Calls migrateEmbeddings on startup, closeDb on shutdown
- `package.json` - Added better-sqlite3, sqlite-vec, @types/better-sqlite3

## Decisions Made

- Use `sqliteVec.load(db)` instead of `db.loadExtension()` - required for proper parameter binding with prepared statements
- Use `BigInt(rowid)` for vec0 virtual table - sqlite-vec requires BigInt for primary key binding
- Use `Float32Array` directly, not `.buffer` - sqlite-vec accepts typed arrays natively
- Keep `initializeEmbeddings()` as no-op - maintains API compatibility during migration period

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] sqlite-vec API differs from plan**

- **Found during:** Task 1 (database module creation)
- **Issue:** Plan specified `db.loadExtension(sqliteVec.loadablePath)` but sqlite-vec exports `getLoadablePath()` function, and using `loadExtension` breaks parameter binding
- **Fix:** Used `sqliteVec.load(db)` which properly initializes the extension with binding support
- **Files modified:** src/memory/db.ts
- **Verification:** Integration test passed with proper vector search
- **Committed in:** 3e374ed (Task 2 commit, alongside embeddings updates)

**2. [Rule 3 - Blocking] vec0 rowid binding requires BigInt**

- **Found during:** Task 2 (updating embeddings.ts)
- **Issue:** `vecStmt.run(rowid, buffer)` failed with "Only integers are allowed for primary key values"
- **Fix:** Changed to `vecStmt.run(BigInt(rowid), new Float32Array(embedding))`
- **Files modified:** src/memory/embeddings.ts, src/memory/migrate.ts
- **Verification:** Integration test with 2 embeddings inserted and searched successfully
- **Committed in:** 3e374ed (Task 2 commit)

---

**Total deviations:** 2 auto-fixed (2 blocking issues)
**Impact on plan:** Both fixes required for sqlite-vec to function. No scope creep - just API adaptation.

## Issues Encountered

- sqlite-vec documentation sparse for Node.js - resolved by finding official example in GitHub repo
- vec0 search requires `k = ?` constraint, not LIMIT - noted for Plan 02 search implementation

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Database ready for vector search queries (Plan 02)
- Schema includes `embedding MATCH ?` support via vec0
- Search query pattern: `WHERE embedding MATCH ? AND k = ?`
- MCP tool can use `getDb()` for search queries

---

_Phase: 07.1-memory-search-mcp_
_Completed: 2026-01-30_
