---
phase: 12-heartbeat-system
plan: 02
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - src/daemon/gateway.ts
autonomous: true

must_haves:
  truths:
    - "Heartbeat starts when gateway starts"
    - "Heartbeat stops when gateway stops"
    - "Heartbeat logged in startup sequence"
  artifacts:
    - path: "src/daemon/gateway.ts"
      provides: "startHeartbeat/stopHeartbeat calls"
      contains: "startHeartbeat"
  key_links:
    - from: "src/daemon/gateway.ts"
      to: "src/heartbeat/index.js"
      via: "import { startHeartbeat, stopHeartbeat }"
      pattern: "startHeartbeat.*stopHeartbeat"
---

<objective>
Wire heartbeat scheduler into gateway lifecycle (start/stop).

Purpose: Heartbeat runs alongside cron scheduler as a parallel service.
Output: Gateway starts/stops heartbeat with proper logging.
</objective>

<execution_context>
@/home/soham/.claude/get-shit-done/workflows/execute-plan.md
@/home/soham/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-heartbeat-system/12-CONTEXT.md
@.planning/phases/12-heartbeat-system/12-01-SUMMARY.md

# Gateway file to modify

@src/daemon/gateway.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add heartbeat import to gateway</name>
  <files>src/daemon/gateway.ts</files>
  <action>
Add import for heartbeat module near existing cron import:

```typescript
import { startHeartbeat, stopHeartbeat } from "../heartbeat/index.js";
```

Place after the cron import line:

```typescript
import { startScheduler, stopScheduler, loadCronStore } from "../cron/index.js";
```

  </action>
  <verify>
`grep "startHeartbeat" src/daemon/gateway.ts` shows import line.
  </verify>
  <done>
Heartbeat import added to gateway.ts alongside cron import.
  </done>
</task>

<task type="auto">
  <name>Task 2: Start heartbeat in gateway startup</name>
  <files>src/daemon/gateway.ts</files>
  <action>
In startGateway(), add heartbeat start after cron scheduler start.

Find this block (around line 229-234):

```typescript
// Initialize cron system
startScheduler();
log.info(
  { jobs: loadCronStore().jobs.filter((j) => j.enabled).length },
  "Cron scheduler initialized",
);
```

Add heartbeat start immediately after:

```typescript
// Initialize heartbeat system
startHeartbeat();
log.info("Heartbeat scheduler initialized");
```

This keeps the two schedulers together in the startup sequence.
</action>
<verify>
`grep -A2 "startHeartbeat" src/daemon/gateway.ts` shows call and log.
</verify>
<done>
Heartbeat starts after cron scheduler in gateway startup with logging.
</done>
</task>

<task type="auto">
  <name>Task 3: Stop heartbeat in gateway shutdown</name>
  <files>src/daemon/gateway.ts</files>
  <action>
In stopGateway(), add heartbeat stop after cron scheduler stop.

Find this block (around line 516):

```typescript
// Stop cron scheduler
stopScheduler();
```

Add heartbeat stop immediately after:

```typescript
// Stop heartbeat scheduler
stopHeartbeat();
```

This ensures both schedulers are stopped during graceful shutdown.
</action>
<verify>
`grep -B1 -A1 "stopHeartbeat" src/daemon/gateway.ts` shows stop call near stopScheduler.
</verify>
<done>
Heartbeat stops alongside cron scheduler in gateway shutdown.
</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Import present: `grep "heartbeat" src/daemon/gateway.ts | head -3`
3. Start/stop wired: `grep -E "(start|stop)Heartbeat" src/daemon/gateway.ts`
</verification>

<success_criteria>

- [ ] Gateway imports startHeartbeat and stopHeartbeat from heartbeat module
- [ ] startGateway() calls startHeartbeat() after cron initialization
- [ ] stopGateway() calls stopHeartbeat() alongside cron stop
- [ ] Startup logs "Heartbeat scheduler initialized"
- [ ] TypeScript compiles without errors
      </success_criteria>

<output>
After completion, create `.planning/phases/12-heartbeat-system/12-02-SUMMARY.md`
</output>
