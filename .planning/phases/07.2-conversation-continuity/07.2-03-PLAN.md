---
phase: 07.2-conversation-continuity
plan: 03
type: execute
wave: 3
depends_on: ["07.2-01", "07.2-02"]
files_modified:
  - src/daemon/spawner.ts
autonomous: true

must_haves:
  truths:
    - "Claude CLI receives --settings with hooks configuration"
    - "Hook commands use exact klausbot CLI path (not global install)"
    - "SessionStart, PreCompact, SessionEnd hooks all configured"
  artifacts:
    - path: "src/daemon/spawner.ts"
      provides: "Hooks configuration via --settings flag"
      contains: "--settings"
  key_links:
    - from: "src/daemon/spawner.ts"
      to: "process.argv[0], process.argv[1]"
      via: "CLI path construction"
      pattern: "process\\.argv"
---

<objective>
Integrate Claude Code hooks via --settings flag in spawner.

Purpose: Connect klausbot hook CLI to Claude Code session lifecycle
Output: Claude CLI spawned with SessionStart/PreCompact/SessionEnd hooks
</objective>

<execution_context>
@/home/soham/.claude/get-shit-done/workflows/execute-plan.md
@/home/soham/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07.2-conversation-continuity/07.2-RESEARCH.md
@.planning/phases/07.2-conversation-continuity/07.2-01-SUMMARY.md
@.planning/phases/07.2-conversation-continuity/07.2-02-SUMMARY.md

Key patterns from RESEARCH.md:
- Hooks via --settings inline JSON
- Use process.argv[0] + process.argv[1] for CLI path
- Hook command format: `node /path/to/script hook start`
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add hooks configuration function</name>
  <files>src/daemon/spawner.ts</files>
  <action>
In src/daemon/spawner.ts, add getHooksConfig() function after getMcpConfig() (around line 29, after the closing brace of getMcpConfig):

```typescript
/**
 * Get Claude Code hooks configuration
 * Uses exact path to current process for reliable hook invocation
 *
 * Hook lifecycle:
 * - SessionStart: Injects datetime + recent summaries into context
 * - PreCompact: Saves state before context compaction (future use)
 * - SessionEnd: Stores transcript with summary
 *
 * @returns Settings object with hooks configuration
 */
function getHooksConfig(): object {
  // Build command using same invocation as current process
  // Dev: node dist/index.js → node dist/index.js hook start
  // Prod: node /usr/local/bin/klausbot → node /usr/local/bin/klausbot hook start
  const nodeExecutable = process.argv[0];
  const scriptPath = process.argv[1];
  const baseCommand = `"${nodeExecutable}" "${scriptPath}"`;

  return {
    hooks: {
      SessionStart: [{
        // Match startup and resume events (not clear/compact which are fresh starts)
        matcher: 'startup|resume',
        hooks: [{
          type: 'command',
          command: `${baseCommand} hook start`,
          timeout: 10,  // 10 seconds max
        }],
      }],
      PreCompact: [{
        hooks: [{
          type: 'command',
          command: `${baseCommand} hook compact`,
          timeout: 30,  // 30 seconds for state save
        }],
      }],
      SessionEnd: [{
        hooks: [{
          type: 'command',
          command: `${baseCommand} hook end`,
          timeout: 60,  // 60 seconds for summary generation
        }],
      }],
    },
  };
}
```

Key points:
- Quotes around paths handle spaces
- Timeout values allow for API calls (summary generation)
- matcher 'startup|resume' for SessionStart (skip clear/compact restarts)
  </action>
  <verify>TypeScript compiles: `npm run build`</verify>
  <done>getHooksConfig() function added to spawner</done>
</task>

<task type="auto">
  <name>Task 2: Pass hooks via --settings flag</name>
  <files>src/daemon/spawner.ts</files>
  <action>
In queryClaudeCode() function (around line 109), update the args array construction:

1. After `const mcpConfigPath = writeMcpConfigFile();` (line 109), add:
```typescript
// Build hooks settings JSON
const hooksSettings = getHooksConfig();
const settingsJson = JSON.stringify(hooksSettings);
```

2. Update args array (around line 112) to include --settings:
```typescript
// Build command arguments
const args = [
  '--dangerously-skip-permissions',
  '-p', prompt,
  '--output-format', 'json',
  '--append-system-prompt', systemPrompt,
  '--mcp-config', mcpConfigPath,
  '--settings', settingsJson,
];
```

The --settings flag accepts inline JSON and merges with any existing settings.

Note: The existing args array at line 112-118 should be replaced with this new version that includes --settings.
  </action>
  <verify>
Build succeeds: `npm run build`
Spawner includes --settings: `grep -n "settingsJson" src/daemon/spawner.ts`
  </verify>
  <done>Claude CLI spawned with hooks configuration</done>
</task>

<task type="auto">
  <name>Task 3: Add logging for hook configuration</name>
  <files>src/daemon/spawner.ts</files>
  <action>
In queryClaudeCode(), after building args, add debug log:

```typescript
// Log prompt (truncated for readability)
const truncatedPrompt = prompt.length > 100
  ? `${prompt.slice(0, 100)}...`
  : prompt;
logger.info(
  { prompt: truncatedPrompt, timeout, model: options.model, cwd: KLAUSBOT_HOME },
  'Spawning Claude Code'
);
logger.debug({ hooksConfig: hooksSettings }, 'Hook configuration');
```

This logs hook config at debug level (visible when LOG_LEVEL=debug).
  </action>
  <verify>Build succeeds: `npm run build`</verify>
  <done>Hook configuration logged for debugging</done>
</task>

</tasks>

<verification>
1. Build succeeds: `npm run build`
2. Gateway starts without error: `npx tsx src/index.ts daemon` (Ctrl+C after startup)
3. Hooks in args: Add temporary console.log(args) before spawn(), verify --settings present
4. Integration test (requires Telegram):
   - Send message to bot
   - Check ~/.klausbot/logs/klausbot.log for hook debug output
   - Check `sqlite3 ~/.klausbot/klausbot.db "SELECT session_id, summary FROM conversations LIMIT 1"`
</verification>

<success_criteria>
- Claude CLI receives --settings flag with hooks JSON
- Hook commands constructed with absolute paths
- All three hook types configured (SessionStart, PreCompact, SessionEnd)
- Existing MCP config and other flags preserved
</success_criteria>

<output>
After completion, create `.planning/phases/07.2-conversation-continuity/07.2-03-SUMMARY.md`
</output>
