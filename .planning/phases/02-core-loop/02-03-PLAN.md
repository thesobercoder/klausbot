---
phase: 02-core-loop
plan: 03
type: execute
wave: 3
depends_on: ["02-01", "02-02"]
files_modified:
  - src/daemon/gateway.ts
  - src/index.ts
  - src/config/schema.ts
autonomous: true

must_haves:
  truths:
    - "User message logged before Claude processes it"
    - "Claude response logged after processing"
    - "~/.klausbot/ initialized at gateway startup"
    - "CLI supports 'klausbot gateway' and 'klausbot init' subcommands"
  artifacts:
    - path: "src/daemon/gateway.ts"
      provides: "Gateway with memory initialization and conversation logging"
      exports: ["startGateway", "stopGateway"]
    - path: "src/index.ts"
      provides: "CLI with init subcommand"
      exports: ["main"]
  key_links:
    - from: "src/daemon/gateway.ts"
      to: "src/memory/index.ts"
      via: "import { initializeHome, initializeIdentity, logUserMessage, logAssistantMessage }"
      pattern: "import.*initializeHome.*memory"
    - from: "src/daemon/gateway.ts"
      to: "processMessage"
      via: "logUserMessage before queryClaudeCode"
      pattern: "logUserMessage.*msg\\.text"
    - from: "src/daemon/gateway.ts"
      to: "processMessage"
      via: "logAssistantMessage after response"
      pattern: "logAssistantMessage.*response\\.result"
---

<objective>
Wire memory system into gateway (initialize at startup, log conversations) and add 'init' CLI subcommand.

Purpose: Complete the core loop where messages are logged and Claude has memory access.
Output: Working end-to-end flow from Telegram message to Claude with memory context.
</objective>

<execution_context>
@/home/soham/.claude/get-shit-done/workflows/execute-plan.md
@/home/soham/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-core-loop/02-CONTEXT.md
@.planning/phases/02-core-loop/02-RESEARCH.md
@src/daemon/gateway.ts
@src/index.ts
@src/memory/index.ts (from 02-01, 02-02)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire memory into gateway</name>
  <files>src/daemon/gateway.ts</files>
  <action>
Modify src/daemon/gateway.ts:

1. Add imports at top:
```typescript
import {
  initializeHome,
  initializeIdentity,
  logUserMessage,
  logAssistantMessage,
} from '../memory/index.js';
```

2. In startGateway(), add initialization BEFORE existing ensureDataDir:
```typescript
export async function startGateway(): Promise<void> {
  log.info('Starting gateway...');

  // Initialize ~/.klausbot/ data home and identity files
  initializeHome(log);
  initializeIdentity(log);

  // Initialize data directory and components (existing)
  ensureDataDir(config.DATA_DIR);
  // ... rest unchanged
}
```

3. In processMessage(), add conversation logging:
- BEFORE queryClaudeCode call: logUserMessage(msg.text)
- AFTER successful response (before sendLongMessage): logAssistantMessage(response.result)
- Do NOT log on error (failed messages don't get assistant response)

```typescript
async function processMessage(msg: QueuedMessage): Promise<void> {
  const startTime = Date.now();

  // ... typing indicator setup unchanged ...

  try {
    // Log user message BEFORE processing (per CONTEXT.md: log original message)
    logUserMessage(msg.text);

    // Call Claude
    const response = await queryClaudeCode(msg.text);

    // Stop typing indicator
    clearInterval(typingInterval);

    // Mark as complete
    queue.complete(msg.id);

    // Send response (handles splitting for long messages)
    if (response.is_error) {
      await bot.api.sendMessage(msg.chatId, `Error (Claude): ${response.result}`);
    } else {
      // Log assistant response AFTER success
      logAssistantMessage(response.result);

      const messages = await splitAndSend(msg.chatId, response.result);
      // ... rest unchanged
    }
    // ... rest unchanged
  } catch (err) {
    // ... error handling unchanged (no logging on error)
  }
}
```
  </action>
  <verify>
```bash
cd /Users/soham/Documents/GitHub/clawdbot && npm run build

# Verify imports
grep "initializeHome" dist/daemon/gateway.js
grep "logUserMessage" dist/daemon/gateway.js
grep "logAssistantMessage" dist/daemon/gateway.js
```
  </verify>
  <done>Gateway initializes memory at startup and logs user/assistant messages to conversation file</done>
</task>

<task type="auto">
  <name>Task 2: Add init CLI subcommand</name>
  <files>src/index.ts</files>
  <action>
Modify src/index.ts:

1. Add 'init' case in main() switch:
```typescript
case 'init': {
  // Initialize ~/.klausbot/ without starting gateway
  const { createChildLogger } = await import('./utils/logger.js');
  const { initializeHome, initializeIdentity, KLAUSBOT_HOME } = await import('./memory/index.js');

  const log = createChildLogger('init');
  console.log(`Initializing klausbot data home at ${KLAUSBOT_HOME}...`);

  initializeHome(log);
  initializeIdentity(log);

  console.log('Done! Created:');
  console.log('  ~/.klausbot/config/');
  console.log('  ~/.klausbot/conversations/');
  console.log('  ~/.klausbot/identity/SOUL.md');
  console.log('  ~/.klausbot/identity/IDENTITY.md');
  console.log('  ~/.klausbot/identity/USER.md');
  break;
}
```

2. Update printHelp() to include init command:
```typescript
function printHelp(): void {
  console.log(`
klausbot - Telegram gateway for Claude Code

Usage:
  klausbot [daemon]                   Start the gateway daemon (default)
  klausbot gateway                    Start the gateway daemon (alias)
  klausbot init                       Initialize ~/.klausbot/ directory
  klausbot install                    Interactive installation wizard
  klausbot pairing approve <code>     Approve pairing request
  klausbot pairing reject <code>      Reject pairing request
  klausbot pairing list               List pending/approved
  klausbot pairing revoke <chatId>    Revoke access
  klausbot version                    Show version
  klausbot help                       Show this help

Environment Variables:
  TELEGRAM_BOT_TOKEN    Telegram bot token (required)
  DATA_DIR              Data directory (default: ./data)
  LOG_LEVEL             Log level (default: info)
`.trim());
}
```

3. Add 'gateway' as explicit alias for 'daemon':
```typescript
case 'daemon':
case 'gateway':  // Explicit alias per CONTEXT.md
case undefined:
case '': {
  // ... existing daemon code
}
```
  </action>
  <verify>
```bash
cd /Users/soham/Documents/GitHub/clawdbot && npm run build

# Test init subcommand exists
grep -A10 "case 'init'" dist/index.js

# Test gateway alias
grep "case 'gateway'" dist/index.js

# Test help updated
grep "init.*Initialize" dist/index.js
```
  </verify>
  <done>CLI supports 'klausbot init' and 'klausbot gateway' subcommands with updated help</done>
</task>

</tasks>

<verification>
```bash
cd /Users/soham/Documents/GitHub/clawdbot

# Full build succeeds
npm run build

# Type check passes
npx tsc --noEmit

# Test CLI help shows new commands
node dist/index.js help | grep init
node dist/index.js help | grep gateway

# Verify init command works (creates dirs)
node dist/index.js init
ls ~/.klausbot/identity/
# Should show: IDENTITY.md  SOUL.md  USER.md
```
</verification>

<success_criteria>
- Gateway initializes ~/.klausbot/ at startup
- User messages logged before Claude processing
- Assistant responses logged after successful processing
- 'klausbot init' creates data home without starting gateway
- 'klausbot gateway' works as alias for daemon
- Help text updated with new commands
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-loop/02-03-SUMMARY.md`
</output>
