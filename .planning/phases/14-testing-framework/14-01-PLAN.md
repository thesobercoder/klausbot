---
phase: 14-testing-framework
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - vitest.config.ts
  - package.json
  - tests/helpers/db.ts
  - tests/helpers/mocks.ts
  - tests/helpers/fixtures.ts
autonomous: true

must_haves:
  truths:
    - "npm test runs vitest and exits cleanly"
    - "npm run test:coverage reports v8 coverage"
    - "Test helpers provide in-memory DB, mock logger, and fixture factories"
  artifacts:
    - path: "vitest.config.ts"
      provides: "Vitest configuration"
      contains: "defineConfig"
    - path: "tests/helpers/db.ts"
      provides: "In-memory SQLite test DB factory"
      contains: "createTestDb"
    - path: "tests/helpers/mocks.ts"
      provides: "Shared mock implementations"
      contains: "createMockLogger"
    - path: "tests/helpers/fixtures.ts"
      provides: "Test data factories"
      contains: "createConversationRecord"
  key_links:
    - from: "vitest.config.ts"
      to: "tests/**/*.test.ts"
      via: "include glob pattern"
      pattern: "tests/\\*\\*/\\*.test\\.ts"
    - from: "tests/helpers/db.ts"
      to: "src/memory/schema.ts"
      via: "schema import for drizzle"
      pattern: "import.*schema"
---

<objective>
Set up Vitest test infrastructure with configuration, npm scripts, and shared test helpers.

Purpose: Foundation for all subsequent test plans. No tests can run without this.
Output: vitest.config.ts, test helpers (db, mocks, fixtures), npm scripts (test, test:coverage)
</objective>

<execution_context>
@/home/soham/.claude/get-shit-done/workflows/execute-plan.md
@/home/soham/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-testing-framework/14-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Vitest and create configuration</name>
  <files>package.json, vitest.config.ts</files>
  <action>
1. Install dev dependencies:
   ```
   npm install -D vitest @vitest/coverage-v8
   ```

2. Create `vitest.config.ts` in project root:
   - Use `defineConfig` from `vitest/config`
   - Set `test.globals: true` (enables describe/it/expect without imports)
   - Set `test.include: ["tests/**/*.test.ts"]`
   - Configure coverage:
     - provider: "v8"
     - include: ["src/**/*.ts"]
     - exclude: ["src/index.ts", "src/cli/**"]
     - reporter: ["text", "json-summary"]
     - thresholds: statements 40, branches 30, functions 40, lines 40
   - Set `test.testTimeout: 10000` (10s default, some tests create DBs)

3. Add npm scripts to package.json:
   - `"test": "vitest run"` (single run, CI-friendly)
   - `"test:watch": "vitest"` (watch mode for dev)
   - `"test:coverage": "vitest run --coverage"`

Do NOT add `types: ["vitest/globals"]` to tsconfig.json — Vitest handles this via its own config. The existing tsconfig only covers src/.
</action>
<verify>

- `npx vitest run` exits with "no test files found" (not a config error)
- `npm test` runs the same command
- `npm run test:coverage` runs coverage (exits with no tests found, not error)
  </verify>
  <done>Vitest installed, configured, npm scripts work. Zero tests is expected — infrastructure only.</done>
  </task>

<task type="auto">
  <name>Task 2: Create shared test helpers</name>
  <files>tests/helpers/db.ts, tests/helpers/mocks.ts, tests/helpers/fixtures.ts</files>
  <action>
1. Create `tests/helpers/db.ts`:
   - Export `createTestDb()` function
   - Creates `new Database(":memory:")` via better-sqlite3
   - Sets `pragma("journal_mode = WAL")`
   - Runs CREATE TABLE for conversations (matching src/memory/db.ts runMigrations SQL exactly):
     - conversations table with id, session_id (unique), started_at, ended_at, transcript, summary, message_count, chat_id
     - Indexes: idx_conversations_ended_at, idx_conversations_chat_id
   - Runs CREATE TABLE for conversation_embeddings (id, conversation_id, chunk_index, text)
   - Do NOT load sqlite-vec extension (not needed for unit tests, causes native addon issues)
   - Do NOT create FTS5 virtual table (not needed for unit tests)
   - Wraps with `drizzle(sqlite, { schema })` importing `* as schema from "../../src/memory/schema.js"`
   - Returns `{ sqlite, db, close: () => sqlite.close() }`

2. Create `tests/helpers/mocks.ts`:
   - Export `createMockLogger()`: Returns object matching pino Logger interface used in codebase:
     `{ info: vi.fn(), debug: vi.fn(), warn: vi.fn(), error: vi.fn(), child: vi.fn().mockReturnThis(), fatal: vi.fn(), trace: vi.fn(), silent: vi.fn(), level: "info" }`
   - Export `mockSpawnerResult(overrides?)`: Returns default queryClaudeCode response:
     `{ result: "Mock response", cost_usd: 0, session_id: "test-session", duration_ms: 100, is_error: false, ...overrides }`
   - Export `mockBotApi()`: Returns mock bot.api object:
     `{ sendMessage: vi.fn().mockResolvedValue({ message_id: 1 }), sendChatAction: vi.fn().mockResolvedValue(true) }`

3. Create `tests/helpers/fixtures.ts`:
   - Export `createConversationRecord(overrides?)`: Returns ConversationRecord with sensible defaults:
     sessionId: "test-session-1", startedAt/endedAt: ISO strings (now - 1h / now), transcript: valid JSONL with one user + one assistant entry, summary: "Test conversation", messageCount: 2, chatId: 12345
   - Export `createCronJob(overrides?)`: Returns CronJob with defaults:
     id: "test-job-1", name: "Test Job", schedule: { kind: "every", everyMs: 300000, anchorMs: Date.now() }, instruction: "Test instruction", chatId: 12345, enabled: true, etc.
   - Import types from source: `ConversationRecord` from `../../src/memory/conversations.js`, `CronJob` from `../../src/cron/types.js`

Ensure all helpers use `.js` extensions in import paths (ESM requirement matching the codebase convention).
</action>
<verify>

- Create a minimal smoke test `tests/helpers/smoke.test.ts` that imports all three helpers and calls each factory:

  ```
  import { createTestDb } from "./db.js";
  import { createMockLogger } from "./mocks.js";
  import { createConversationRecord } from "./fixtures.js";

  describe("test helpers", () => {
    it("creates test db", () => {
      const { db, close } = createTestDb();
      expect(db).toBeDefined();
      close();
    });
    it("creates mock logger", () => {
      const logger = createMockLogger();
      logger.info("test");
      expect(logger.info).toHaveBeenCalled();
    });
    it("creates fixture", () => {
      const record = createConversationRecord();
      expect(record.sessionId).toBe("test-session-1");
    });
  });
  ```

- Run `npm test` — all 3 tests pass
- Delete `tests/helpers/smoke.test.ts` after verification (it served its purpose)
  </verify>
  <done>Test helpers work. In-memory DB creates and closes cleanly. Mocks return correct shapes. Fixtures produce valid typed objects.</done>
  </task>

</tasks>

<verification>
- `npm test` exits 0 (or "no test files" if smoke test deleted)
- `npm run test:coverage` shows v8 coverage header
- All files in tests/helpers/ compile without TypeScript errors
- `npm run check` still passes (existing CI pipeline unaffected)
</verification>

<success_criteria>

1. Vitest installed and configured
2. npm test / test:watch / test:coverage scripts work
3. Test helpers (db, mocks, fixtures) importable and functional
4. No impact on existing build or check pipeline
   </success_criteria>

<output>
After completion, create `.planning/phases/14-testing-framework/14-01-SUMMARY.md`
</output>
