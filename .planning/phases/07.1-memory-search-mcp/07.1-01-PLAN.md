---
phase: 07.1-memory-search-mcp
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/memory/db.ts
  - src/memory/embeddings.ts
  - src/memory/migrate.ts
  - src/memory/home.ts
autonomous: true

must_haves:
  truths:
    - "Embeddings stored in SQLite instead of JSON file"
    - "Old embeddings migrated from JSON on first load"
    - "New embeddings written to SQLite only"
  artifacts:
    - path: "src/memory/db.ts"
      provides: "SQLite database with vec0 extension"
      exports: ["getDb", "closeDb"]
    - path: "src/memory/migrate.ts"
      provides: "JSON to SQLite migration"
      exports: ["migrateEmbeddings"]
  key_links:
    - from: "src/memory/embeddings.ts"
      to: "src/memory/db.ts"
      via: "getDb() for inserts"
      pattern: "getDb\\(\\)"
    - from: "src/memory/db.ts"
      to: "sqlite-vec"
      via: "loadExtension"
      pattern: "loadExtension"
---

<objective>
SQLite vector storage foundation for embeddings

Purpose: Replace single JSON file storage with SQLite + sqlite-vec for efficient vector search. JSON file becomes write bottleneck with many embeddings.

Output: Database module, updated embeddings storage, migration script
</objective>

<execution_context>
@/home/soham/.claude/get-shit-done/workflows/execute-plan.md
@/home/soham/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07.1-memory-search-mcp/07.1-RESEARCH.md

@src/memory/embeddings.ts
@src/memory/home.ts
@src/memory/logger.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create database module</name>
  <files>
    package.json
    src/memory/db.ts
    src/memory/home.ts
  </files>
  <action>
Install better-sqlite3 and sqlite-vec:
```bash
npm install better-sqlite3 sqlite-vec
npm install -D @types/better-sqlite3
```

Create `src/memory/db.ts`:
- Import better-sqlite3 and sqlite-vec
- Lazy-initialize DB at `~/.klausbot/klausbot.db`
- Load sqlite-vec extension: `db.loadExtension(sqliteVec.loadablePath)`
- Enable WAL mode: `db.pragma('journal_mode = WAL')`
- Create schema on first access:
  ```sql
  CREATE TABLE IF NOT EXISTS embeddings (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    text_id TEXT UNIQUE NOT NULL,
    text TEXT NOT NULL,
    timestamp TEXT NOT NULL,
    source TEXT NOT NULL
  );
  CREATE INDEX IF NOT EXISTS idx_embeddings_timestamp ON embeddings(timestamp);
  CREATE INDEX IF NOT EXISTS idx_embeddings_source ON embeddings(source);

  CREATE VIRTUAL TABLE IF NOT EXISTS vec_embeddings USING vec0(
    embedding float[1536]
  );
  ```
- Export `getDb()` (lazy init), `closeDb()` (for cleanup)
- Use `sqliteVec.loadablePath` to get extension path (sqlite-vec exports this)

Update `src/memory/home.ts`:
- Add 'db' or handle db file location in getHomePath usage

PITFALL AVOIDANCE:
- sqlite-vec requires Float32Array buffer for insertions, not number[]
- vec0 rowid must match main table rowid for joins
- Enable WAL mode immediately after opening
  </action>
  <verify>
`npm run build` succeeds
`node -e "require('./dist/memory/db.js')"` loads without error
  </verify>
  <done>
Database module exports getDb/closeDb, schema created on init
  </done>
</task>

<task type="auto">
  <name>Task 2: Update embeddings.ts for SQLite storage</name>
  <files>
    src/memory/embeddings.ts
    src/memory/migrate.ts
  </files>
  <action>
Update `src/memory/embeddings.ts`:
- Import `getDb` from `./db.js`
- Remove JSON file read/write functions (loadEmbeddings, saveEmbeddings, getEmbeddingsPath)
- Update `storeEmbedding()`:
  ```typescript
  const db = getDb();
  const stmt = db.prepare(`
    INSERT INTO embeddings (text_id, text, timestamp, source)
    VALUES (?, ?, ?, ?)
  `);
  const vecStmt = db.prepare(`
    INSERT INTO vec_embeddings (rowid, embedding)
    VALUES (?, ?)
  `);

  // For each chunk:
  const textId = `${source}-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`;
  const info = stmt.run(textId, chunk, timestamp, source);
  const rowid = info.lastInsertRowid;

  // Convert embedding to Float32Array buffer for sqlite-vec
  const buffer = new Float32Array(embedding).buffer;
  vecStmt.run(rowid, buffer);
  ```
- Keep `generateEmbedding()` unchanged (still uses OpenAI)
- Keep `chunkText()` unchanged
- Remove `initializeEmbeddings()` or make it a no-op (db handles init)

Create `src/memory/migrate.ts`:
- Function `migrateEmbeddings()`:
  - Check if `~/.klausbot/embeddings.json` exists
  - If not, return early (nothing to migrate)
  - Read JSON file
  - For each entry: insert into embeddings table + vec_embeddings
  - After successful migration, rename JSON to `embeddings.json.migrated`
  - Log migration count
- Called once on first db access or app startup

PITFALL AVOIDANCE:
- Check for DB existence before JSON fallback (avoid race during migration)
- Use transaction for bulk migration insert
- Float32Array.buffer for sqlite-vec insertions
  </action>
  <verify>
`npm run build` succeeds
Manually test: create test embedding, verify in SQLite:
```bash
sqlite3 ~/.klausbot/klausbot.db "SELECT count(*) FROM embeddings"
```
  </verify>
  <done>
Embeddings stored in SQLite, JSON migration works, old file renamed after migration
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire migration into startup and update module exports</name>
  <files>
    src/memory/index.ts
    src/gateway/gateway.ts
  </files>
  <action>
Update `src/memory/index.ts` (or create if not exists):
- Export all from embeddings.ts
- Export `migrateEmbeddings` from migrate.ts
- Export `getDb`, `closeDb` from db.ts

Update gateway startup (src/gateway/gateway.ts or wherever initializeHome is called):
- After `initializeHome(logger)`, call `migrateEmbeddings()`
- Migration is idempotent (checks for JSON file, no-op if already migrated)

Ensure `closeDb()` called on shutdown (in stop() or cleanup function).

VERIFICATION: After changes, the flow is:
1. Gateway starts
2. initializeHome creates directories
3. migrateEmbeddings moves JSON to SQLite (if JSON exists)
4. storeEmbedding writes to SQLite
5. On shutdown, closeDb called
  </action>
  <verify>
`npm run build` succeeds
Start gateway briefly, check:
- No errors in logs
- If embeddings.json existed, now embeddings.json.migrated
- klausbot.db exists at ~/.klausbot/
  </verify>
  <done>
Migration runs on startup, module exports updated, clean shutdown
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. `npm run build` - must pass
2. SQLite database created at ~/.klausbot/klausbot.db
3. If embeddings.json existed, migrated to SQLite and renamed
4. New embeddings go to SQLite only
5. vec_embeddings table has vector data
</verification>

<success_criteria>
- better-sqlite3 and sqlite-vec installed
- Database module with lazy init, WAL mode, schema creation
- embeddings.ts writes to SQLite, not JSON
- Migration script moves old data
- Gateway startup calls migration
</success_criteria>

<output>
After completion, create `.planning/phases/07.1-memory-search-mcp/07.1-01-SUMMARY.md`
</output>
