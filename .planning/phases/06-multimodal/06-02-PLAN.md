---
phase: 06-multimodal
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/media/storage.ts
  - src/media/index.ts
  - src/memory/home.ts
autonomous: true

must_haves:
  truths:
    - "Images persist across sessions in organized storage (~/.klausbot/images/{date}/)"
    - "Images saved with unique filenames prevent collisions"
    - "Media module exports all public functions from single entry point"
  artifacts:
    - path: "src/media/storage.ts"
      provides: "Image file storage with dated directories"
      exports: ["saveImage", "getImageDir"]
    - path: "src/media/index.ts"
      provides: "Barrel export for media module"
      exports: ["*"]
    - path: "src/memory/home.ts"
      provides: "Updated DIRS to include 'images'"
      contains: "'images'"
  key_links:
    - from: "src/media/storage.ts"
      to: "src/memory/home.ts"
      via: "KLAUSBOT_HOME import"
      pattern: "KLAUSBOT_HOME"
    - from: "src/media/index.ts"
      to: "src/media/*.ts"
      via: "re-exports"
      pattern: "export \\* from"
---

<objective>
Create image storage system and media module exports.

Purpose: Enable image persistence and provide clean module interface for media functionality.
Output: Image storage in dated directories, barrel export for media module.
</objective>

<execution_context>
@/home/soham/.claude/get-shit-done/workflows/execute-plan.md
@/home/soham/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-multimodal/06-CONTEXT.md
@.planning/phases/06-multimodal/06-RESEARCH.md
@src/memory/home.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update home.ts to include images directory</name>
  <files>src/memory/home.ts</files>
  <action>
Read current `src/memory/home.ts`.

Update the DIRS constant to include 'images':

```typescript
export const DIRS = [
  "config",
  "conversations",
  "identity",
  "cron",
  "images",
] as const;
```

This ensures ~/.klausbot/images/ is created during initializeHome().

No other changes needed â€” existing initializeHome() will create the directory.
</action>
<verify>

1. `grep "images" src/memory/home.ts` shows 'images' in DIRS
2. `npx tsc --noEmit` passes
   </verify>
   <done>

- DIRS includes 'images'
- ~/.klausbot/images/ created on startup
  </done>
  </task>

<task type="auto">
  <name>Task 2: Image storage module</name>
  <files>src/media/storage.ts</files>
  <action>
Create `src/media/storage.ts`:

Import:

- existsSync, mkdirSync, copyFileSync from fs
- join from path
- randomUUID from crypto
- KLAUSBOT_HOME from '../memory/home.js'
- createChildLogger from '../utils/index.js'

Create logger: createChildLogger('media:storage')

Export `getImageDir(): string`:

- Get today's date as YYYY-MM-DD (use toISOString().split('T')[0])
- Return path: join(KLAUSBOT_HOME, 'images', dateStr)

Export `saveImage(sourcePath: string, originalFilename?: string): string`:

- Get imageDir from getImageDir()
- Create directory if not exists: mkdirSync(imageDir, { recursive: true })
- Generate unique filename:
  - Extract extension from originalFilename or sourcePath (default to '.jpg')
  - Filename: `${randomUUID()}${extension}`
- Destination: join(imageDir, filename)
- Copy file: copyFileSync(sourcePath, destination)
- Log: { source, destination, size } (get size from statSync if desired, or skip)
- Return destination path (absolute)

Handle errors:

- If copy fails, throw Error with 'Failed to save image: ' + message
  </action>
  <verify>

1. `npx tsc --noEmit` passes
2. saveImage and getImageDir exported
3. Uses KLAUSBOT_HOME for base path
   </verify>
   <done>

- saveImage copies image to ~/.klausbot/images/{date}/{uuid}.{ext}
- getImageDir returns today's image directory path
- Directory created on demand
  </done>
  </task>

<task type="auto">
  <name>Task 3: Media module barrel export</name>
  <files>src/media/index.ts</files>
  <action>
Create `src/media/index.ts`:

Re-export all public symbols from submodules:

```typescript
// Types
export * from "./types.js";

// Download
export { downloadFile, hydrateFilesOnBot } from "./download.js";

// Transcription
export { transcribeAudio, isTranscriptionAvailable } from "./transcribe.js";

// Storage
export { saveImage, getImageDir } from "./storage.js";

// Retry
export { withRetry, isTransientError } from "./retry.js";
```

Note: Use explicit named exports (not `export *`) for functions to avoid potential conflicts and make API explicit.
</action>
<verify>

1. `npx tsc --noEmit` passes
2. `grep "export" src/media/index.ts` shows all expected exports
   </verify>
   <done>

- src/media/index.ts re-exports all public API
- Single import point: `import { ... } from './media/index.js'`
  </done>
  </task>

</tasks>

<verification>
```bash
# All files compile
npx tsc --noEmit

# Home includes images

grep "images" src/memory/home.ts

# Media index exports all modules

grep "export" src/media/index.ts

```
</verification>

<success_criteria>
- src/memory/home.ts DIRS includes 'images'
- src/media/storage.ts exports saveImage, getImageDir
- src/media/index.ts barrel exports all media module functions
- Image storage uses ~/.klausbot/images/{date}/ structure
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-multimodal/06-02-SUMMARY.md`
</output>
```
