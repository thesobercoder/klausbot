---
phase: 13.2-subagent-orchestration
plan: 01
subsystem: daemon
tags: [subagents, task-tool, claude-code, orchestration, spawn]

# Dependency graph
requires:
  - phase: 10-telegram-streaming
    provides: Streaming infrastructure in spawner
provides:
  - Task tool enablement via --allowedTools flag
  - Orchestration instructions for subagent spawning
  - Configurable subagents section in jsonConfigSchema
  - Per-session task list ID generation
affects: [testing, future-multi-agent-patterns]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Env var injection for Claude CLI (CLAUDE_CODE_TASK_LIST_ID)"
    - "System prompt composition with conditional sections"

key-files:
  created: []
  modified:
    - src/daemon/spawner.ts
    - src/telegram/streaming.ts
    - src/memory/context.ts
    - src/memory/index.ts
    - src/config/schema.ts
    - src/daemon/gateway.ts

key-decisions:
  - "Subagents enabled by default (config.subagents.enabled: true)"
  - "Task list ID format: {prefix}-{chatId}-{timestamp} for uniqueness"
  - "Orchestration instructions skip bootstrap mode"

patterns-established:
  - "Conditional arg injection: if (options.X) args.push(...)"
  - "Env spreading: const env = { ...process.env }; env.VAR = value;"

# Metrics
duration: 4min
completed: 2026-02-05
---

# Phase 13.2 Plan 01: Subagent Orchestration Summary

**Task tool enablement via --allowedTools flag with per-session task list IDs and XML orchestration instructions**

## Performance

- **Duration:** 4 min
- **Started:** 2026-02-05T (execution start)
- **Completed:** 2026-02-05T
- **Tasks:** 3/3
- **Files modified:** 6

## Accomplishments

- SpawnerOptions and StreamOptions have enableSubagents and taskListId fields
- Both spawner functions conditionally add --allowedTools Task flag
- Both spawner functions conditionally set CLAUDE_CODE_TASK_LIST_ID env var
- getOrchestrationInstructions() returns XML-wrapped Task tool guidance
- jsonConfigSchema has subagents.enabled and subagents.taskListIdPrefix
- Gateway wires subagent config to both streaming and batch paths
- Task list ID unique per session (prefix-chatId-timestamp)

## Task Commits

Each task was committed atomically:

1. **Task 1: Enable Task tool in spawner** - `47f88ae` (feat)
2. **Task 2: Add orchestration instructions to system prompt** - `a2ae575` (feat)
3. **Task 3: Add config schema and wire to gateway** - `f730afb` (feat)

## Files Created/Modified

- `src/daemon/spawner.ts` - Added enableSubagents, taskListId to options; conditional --allowedTools Task flag; env var injection
- `src/telegram/streaming.ts` - Same as spawner; also updated StreamToTelegramOptions
- `src/memory/context.ts` - Added getOrchestrationInstructions() function
- `src/memory/index.ts` - Exported getOrchestrationInstructions
- `src/config/schema.ts` - Added subagents section (enabled, taskListIdPrefix)
- `src/daemon/gateway.ts` - Generate taskListId per session; append orchestration instructions; pass options to both paths

## Decisions Made

- Subagents enabled by default (true) - assumes users want full capability
- Task list ID includes chatId and timestamp - unique per chat session
- Orchestration instructions skip bootstrap mode - identity must exist first
- Config uses defaults that require no setup: enabled=true, prefix="klausbot"

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None.

## User Setup Required

None - no external service configuration required. Subagents enabled by default.

Optional config in `~/.klausbot/config/klausbot.json`:

```json
{
  "subagents": {
    "enabled": false,
    "taskListIdPrefix": "custom-prefix"
  }
}
```

## Next Phase Readiness

- Subagent orchestration infrastructure complete
- Claude can now spawn parallel agents via Task tool
- Ready for Phase 14 (Testing Framework)
- No blockers

---

_Phase: 13.2-subagent-orchestration_
_Completed: 2026-02-05_
