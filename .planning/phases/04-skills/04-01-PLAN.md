---
phase: 04-skills
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/telegram/skills.ts
  - src/daemon/gateway.ts
autonomous: true

must_haves:
  truths:
    - "Skills from ~/.claude/skills/ appear in Telegram / menu"
    - "User can invoke /skill <name> [args] via Telegram"
    - "User can invoke /<skillname> [args] directly"
  artifacts:
    - path: "src/telegram/skills.ts"
      provides: "Skill command registration and routing"
      exports: ["registerSkillCommands", "getInstalledSkillNames"]
  key_links:
    - from: "src/telegram/skills.ts"
      to: "~/.claude/skills/"
      via: "readdirSync"
      pattern: "\.claude.*skills"
    - from: "src/telegram/skills.ts"
      to: "bot.api.setMyCommands"
      via: "Telegram API"
      pattern: "setMyCommands"
---

<objective>
Surface Claude Code skills to Telegram by registering them as bot commands.

Purpose: Users see available skills in Telegram's / menu and can invoke them.
Output: Skills appear in Telegram, invocations pass through to Claude Code.
</objective>

<context>
@.planning/PROJECT.md
@.planning/phases/04-skills/04-CONTEXT.md
@src/daemon/gateway.ts
@src/telegram/commands.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Telegram skills module</name>
  <files>src/telegram/skills.ts</files>
  <action>
Create src/telegram/skills.ts with:

1. **getInstalledSkillNames() function:**

   ```typescript
   import { readdirSync, existsSync, readFileSync } from "fs";
   import { homedir } from "os";
   import { join } from "path";

   const SKILLS_DIR = join(homedir(), ".claude", "skills");

   export function getInstalledSkillNames(): string[] {
     if (!existsSync(SKILLS_DIR)) return [];

     return readdirSync(SKILLS_DIR, { withFileTypes: true })
       .filter((d) => d.isDirectory())
       .filter((d) => existsSync(join(SKILLS_DIR, d.name, "SKILL.md")))
       .map((d) => d.name);
   }
   ```

2. **getSkillDescription(name: string) function:**
   - Read SKILL.md, extract description from YAML frontmatter
   - Return description or fallback to skill name

   ```typescript
   export function getSkillDescription(name: string): string {
     const skillPath = join(SKILLS_DIR, name, "SKILL.md");
     if (!existsSync(skillPath)) return name;

     const content = readFileSync(skillPath, "utf-8");
     const match = content.match(/^---\n[\s\S]*?description:\s*(.+)/m);
     return match ? match[1].trim().slice(0, 250) : name;
   }
   ```

3. **normalizeCommandName(skillName: string) function:**
   - Convert hyphens to underscores (Telegram requirement)
   - Lowercase, max 32 chars

   ```typescript
   function normalizeCommandName(name: string): string {
     return name.toLowerCase().replace(/-/g, "_").slice(0, 32);
   }
   ```

4. **registerSkillCommands(bot: Bot) async function:**
   - Get installed skill names
   - Build BotCommand array with built-ins + skills:

     ```typescript
     const builtins: BotCommand[] = [
       { command: "start", description: "Start or check pairing" },
       { command: "help", description: "Show available commands" },
       { command: "status", description: "Show queue status" },
       { command: "skill", description: "Run skill: /skill <name> [args]" },
     ];

     const skillCommands = skillNames.map((name) => ({
       command: normalizeCommandName(name),
       description: getSkillDescription(name),
     }));

     await bot.api.setMyCommands([...builtins, ...skillCommands].slice(0, 100));
     ```

   - Log registration count

Use createChildLogger('telegram:skills') for logging.
</action>
<verify>`npx tsc --noEmit` passes</verify>
<done>registerSkillCommands and getInstalledSkillNames exported</done>
</task>

<task type="auto">
  <name>Task 2: Integrate skills into gateway</name>
  <files>src/daemon/gateway.ts</files>
  <action>
Modify src/daemon/gateway.ts:

1. **Import skills module:**

   ```typescript
   import {
     registerSkillCommands,
     getInstalledSkillNames,
   } from "../telegram/skills.js";
   ```

2. **In startGateway(), after bot setup:**

   ```typescript
   // Register skill commands in Telegram menu
   await registerSkillCommands(bot);
   log.info({ skills: getInstalledSkillNames() }, "Registered skill commands");
   ```

3. **No special /skill handler needed:**
   - Regular messages (including /skill invocations) already go to Claude Code
   - Claude Code handles skill selection and execution natively
   - The message flow: User -> Telegram -> Gateway -> Claude Code -> Response

Note: We don't need to parse /skill commands specially. Claude Code receives the full message text and handles skill invocation internally via its Skill tool.
</action>
<verify>`npx tsc --noEmit`; gateway starts without errors</verify>
<done>Skills registered at startup, appear in Telegram / menu</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` compiles without errors
2. `npm run build && npm run gateway` starts without errors
3. In Telegram, type `/` - installed skills should appear in menu
4. Invoke a skill (if any installed): `/skill-creator` or `/skill skill-creator`
</verification>

<success_criteria>

- Skills from ~/.claude/skills/ appear in Telegram command menu
- No new dependencies added
- Gateway passes skill invocations to Claude Code (no special handling)
  </success_criteria>

<output>
After completion, create `.planning/phases/04-skills/04-01-SUMMARY.md`
</output>
