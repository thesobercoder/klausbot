---
phase: 13.3-infinite-conversation-context
plan: 02
type: execute
wave: 2
depends_on: ["13.3-01"]
files_modified:
  - src/daemon/gateway.ts
  - src/cli/hook.ts
autonomous: true

must_haves:
  truths:
    - "Conversation history injected into every non-bootstrap Claude session"
    - "History injection uses chatId from current message for per-chat isolation"
    - "SessionStart hook simplified — no longer injects conversation summaries (moved to system prompt)"
    - "Bootstrap mode skips history injection (identity must exist first)"
    - "Background agent path unaffected (uses --resume, no history injection needed)"
  artifacts:
    - path: "src/daemon/gateway.ts"
      provides: "Conversation context injection in additionalInstructions"
      contains: "buildConversationContext"
    - path: "src/cli/hook.ts"
      provides: "Simplified SessionStart (datetime + session ID only)"
  key_links:
    - from: "src/daemon/gateway.ts"
      to: "src/memory/context.ts"
      via: "buildConversationContext import"
      pattern: "buildConversationContext.*chatId"
    - from: "gateway.processMessage"
      to: "additionalInstructions"
      via: "conversation context appended to instructions"
      pattern: "additionalInstructions.*=.*buildConversationContext"
---

<objective>
Wire conversation context into the gateway and simplify the SessionStart hook.

Purpose: Plan 01 built the context engine. This plan connects it to the actual message processing pipeline so every Claude session receives conversation history. Also simplifies the hook since history is now in the system prompt.

Output: Gateway injects conversation history via `additionalInstructions`. SessionStart hook reduced to datetime + session ID only.
</objective>

<execution_context>
@/home/soham/.claude/get-shit-done/workflows/execute-plan.md
@/home/soham/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13.3-infinite-conversation-context/13.3-RESEARCH.md
@.planning/phases/13.3-infinite-conversation-context/13.3-01-SUMMARY.md

@src/daemon/gateway.ts
@src/cli/hook.ts
@src/memory/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Inject conversation context in gateway processMessage</name>
  <files>src/daemon/gateway.ts</files>
  <action>
**In `src/daemon/gateway.ts`:**

1. Add `buildConversationContext` to the existing import from `"../memory/index.js"` (line ~41, the import block that already imports `invalidateIdentityCache`, `getOrchestrationInstructions`, `storeConversation`, etc.).

2. In the `processMessage()` function, inside the `if (!isBootstrap)` block (around line ~832), add conversation context injection. After the `chatIdContext` variable and BEFORE the `noteInstructions` section, add:

```typescript
// Conversation history injection
let conversationContext = "";
try {
  conversationContext = buildConversationContext(msg.chatId);
  if (conversationContext) {
    log.debug(
      { chatId: msg.chatId, contextLength: conversationContext.length },
      "Injected conversation context",
    );
  }
} catch (err) {
  log.warn({ err, chatId: msg.chatId }, "Failed to build conversation context");
  // Non-fatal: continue without history
}
```

3. Update the `additionalInstructions` assembly (around line ~853) to include `conversationContext`. Change:

```typescript
additionalInstructions =
  chatIdContext + noteInstructions + orchestrationInstructions;
```

To:

```typescript
additionalInstructions =
  chatIdContext +
  conversationContext +
  noteInstructions +
  orchestrationInstructions;
```

The conversation context goes right after chatIdContext (before notes/orchestration) because it's the most important context for natural conversation.

**Important:** Do NOT modify the streaming path or batch path spawn logic — `additionalInstructions` is already passed through to both `streamToTelegram()` and `queryClaudeCode()`, so the conversation context will flow through automatically.

**Important:** The `buildConversationContext` call is wrapped in try/catch because:

- First message ever will have no conversations (returns empty string)
- Database errors should not break message processing
- This is additive context, not critical path
  </action>
  <verify>
  Run `npm run check` — compiles and lints clean. Verify the import and usage:

```
grep -n "buildConversationContext" src/daemon/gateway.ts
```

Should show import line and usage in processMessage.
</verify>
<done>
Gateway injects conversation history into every non-bootstrap Claude session via `additionalInstructions`. History is per-chat (uses `msg.chatId`). Errors are non-fatal (logged and skipped). Bootstrap mode correctly skips injection.
</done>
</task>

<task type="auto">
  <name>Task 2: Simplify SessionStart hook</name>
  <files>src/cli/hook.ts</files>
  <action>
**In `src/cli/hook.ts`:**

Simplify `handleHookStart()` — conversation summaries are now injected via the system prompt in the gateway. The hook should only provide lightweight session metadata.

Replace the current `handleHookStart()` function body. Remove:

- The dynamic import of `getRecentConversations` (line ~79)
- The chatId parsing from env (lines ~85-87)
- The summaries fetching and formatting (lines ~88-101)
- The summaries conditional in the context template (line ~107)

New `handleHookStart()`:

```typescript
export async function handleHookStart(): Promise<void> {
  const input = await readStdin();
  hookLog(`[start] session=${input.session_id}`);

  // Lightweight session metadata only
  // Conversation history is now injected via --append-system-prompt in the gateway
  const datetime = new Date().toISOString();

  const context = `<session-context>
Current datetime: ${datetime}
Session ID: ${input.session_id}
</session-context>`;

  // Write to stdout - Claude adds this to context
  console.log(context);
}
```

This is strictly simpler:

- No dynamic imports
- No database queries
- No env var parsing
- Just datetime + session ID (still useful for Claude to know current time and session tracking)

The `handleHookEnd()` and `handleHookCompact()` functions remain UNCHANGED — they still need to store transcripts and summaries for the new context builder to query.
</action>
<verify>
Run `npm run check` — compiles clean. Verify the hook is simplified:

```
grep -n "getRecentConversations" src/cli/hook.ts
```

Should return NO results (import removed). Verify it still has the session context:

```
grep -n "session-context" src/cli/hook.ts
```

Should show the XML tag still present.
</verify>
<done>
SessionStart hook simplified to datetime + session ID only. No more database queries or conversation summary injection from hooks — that's now handled by the gateway's `buildConversationContext()` via `--append-system-prompt`. Hook end/compact unchanged.
</done>
</task>

</tasks>

<verification>
1. `npm run check` passes (typecheck + lint + format verification)
2. `buildConversationContext` imported and called in `gateway.ts` processMessage
3. Conversation context added to `additionalInstructions` string
4. `hook.ts` handleHookStart no longer imports or calls `getRecentConversations`
5. Hook still outputs `<session-context>` with datetime and session ID
6. Bootstrap mode still skips all additional instructions (including conversation context)
</verification>

<success_criteria>

- Every non-bootstrap message triggers conversation history injection
- History is per-chat (chatId-filtered)
- Errors in context building are non-fatal (caught, logged, skipped)
- SessionStart hook reduced to ~10 lines (datetime + session ID)
- `npm run check` passes clean
- Both streaming and batch paths receive conversation context via existing additionalInstructions flow
  </success_criteria>

<output>
After completion, create `.planning/phases/13.3-infinite-conversation-context/13.3-02-SUMMARY.md`
</output>
