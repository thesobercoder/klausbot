---
phase: 05.1-mcp-cron
plan: 01
subsystem: mcp-server
tags: [mcp, stdio, cron, tools]

dependency-graph:
  requires: [05-cron-service]
  provides: [mcp-cron-tools]
  affects: [05.1-02-spawner-integration]

tech-stack:
  added:
    - "@modelcontextprotocol/sdk": "MCP server and stdio transport"
  patterns:
    - "server.tool() registration with zod schema"
    - "stdio transport for subprocess communication"

key-files:
  created:
    - src/mcp-server/index.ts
    - src/mcp-server/tools/cron.ts
  modified:
    - package.json
    - tsup.config.ts

decisions:
  - "Graceful error messages for schedule parsing failures"
  - "Tools return text content with structured information"
  - "Note: Separate entry point was later refactored to CLI subcommand in 05.1-02"

metrics:
  duration: "2 min"
  completed: "2026-01-30"
---

# Phase 5.1 Plan 01: MCP Server with Cron Tools Summary

Standalone MCP server exposing three cron tools via stdio transport for Claude CLI integration.

## What Was Built

### MCP Server Entry Point

- `src/mcp-server/index.ts`: Creates McpServer instance, registers tools, connects via StdioServerTransport
- Spawned as subprocess by Claude CLI via `--mcp-config` flag

### Cron Tools Module

- `src/mcp-server/tools/cron.ts`: Exports `registerCronTools(server)` with three tools:

| Tool          | Parameters                          | Function                                     |
| ------------- | ----------------------------------- | -------------------------------------------- |
| `create_cron` | name, schedule, instruction, chatId | Parses schedule string, creates job in store |
| `list_crons`  | chatId                              | Returns formatted list of jobs for chat      |
| `delete_cron` | id                                  | Removes job from store                       |

### Build Configuration

- MCP server bundled into main `dist/index.js` (single entry point)
- Invoked via `klausbot mcp` subcommand

## Key Implementation Details

**Schedule parsing:** Tools accept natural language ("every day at 9am") or cron expressions. parseSchedule() from existing cron module handles conversion.

**Error handling:** Tools return descriptive error messages instead of throwing:

- Invalid schedule format: Lists valid formats
- Past dates: Requests future time
- Job not found: Suggests list_crons

**MCP response format:**

```typescript
{
  content: [{ type: "text", text: "..." }];
}
```

## Deviations from Plan

None - plan executed exactly as written.

## Verification Results

| Check                           | Status |
| ------------------------------- | ------ |
| MCP SDK in dependencies         | PASS   |
| stdio transport in index.ts     | PASS   |
| registerCronTools exported      | PASS   |
| Three tools defined             | PASS   |
| dist/mcp-server/index.js exists | PASS   |
| TypeScript compiles             | PASS   |
| MCP initialize response         | PASS   |

## Commits

| Hash    | Type  | Description                                   |
| ------- | ----- | --------------------------------------------- |
| f822d52 | feat  | Install MCP SDK and create server entry point |
| f857778 | feat  | Implement cron MCP tools                      |
| 5e8fcea | chore | Add MCP server as build entry point           |

## Next Phase Readiness

**Ready for 05.1-02:** Spawner integration with --mcp-config flag

**Required for integration:**

- MCP config JSON file specifying server command
- Update spawner.ts to pass --mcp-config flag
- Test tool invocation end-to-end
