---
phase: 05.1-mcp-cron
plan: 02
type: execute
wave: 2
depends_on: ["05.1-01"]
files_modified:
  - src/daemon/spawner.ts
  - src/memory/context.ts
autonomous: false

must_haves:
  truths:
    - "Claude spawns with --mcp-config flag pointing to klausbot MCP server"
    - "Claude can call mcp__klausbot__create_cron to create scheduled tasks"
    - "Claude can call mcp__klausbot__list_crons to see existing tasks"
    - "Cron CLI instructions removed from system prompt"
    - "Existing functionality preserved (identity, memory, skills)"
  artifacts:
    - path: "src/daemon/spawner.ts"
      provides: "MCP config generation and --mcp-config flag"
      contains: "mcp-config"
    - path: "src/memory/context.ts"
      provides: "System prompt without cron CLI instructions"
  key_links:
    - from: "src/daemon/spawner.ts"
      to: "dist/mcp-server/index.js"
      via: "MCP config command path"
      pattern: "mcp-server"
---

<objective>
Integrate MCP server with CLI spawner and verify end-to-end cron management.

Purpose: Connect the MCP server to Claude sessions so typed tools replace CLI commands.
Output: Working integration where Claude uses MCP tools for cron operations.
</objective>

<execution_context>
@/home/soham/.claude/get-shit-done/workflows/execute-plan.md
@/home/soham/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05.1-mcp-cron/05.1-RESEARCH.md
@.planning/phases/05.1-mcp-cron/05.1-01-SUMMARY.md
@src/daemon/spawner.ts
@src/memory/context.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add MCP config generation and spawner integration</name>
  <files>src/daemon/spawner.ts</files>
  <action>
    1. Create a function `getMcpConfig()` that returns MCP server config object:
       ```typescript
       function getMcpConfig(): object {
         // Get path to built MCP server
         // __dirname points to dist/daemon, need dist/mcp-server/index.js
         const mcpServerPath = path.resolve(
           path.dirname(fileURLToPath(import.meta.url)),
           '../mcp-server/index.js'
         );

         return {
           mcpServers: {
             klausbot: {
               command: "node",
               args: [mcpServerPath],
               env: {}
             }
           }
         };
       }
       ```

    2. Create a function to write config to temp file (Claude CLI needs file path):
       ```typescript
       function writeMcpConfigFile(): string {
         const config = getMcpConfig();
         const configPath = path.join(os.tmpdir(), `klausbot-mcp-${process.pid}.json`);
         writeFileSync(configPath, JSON.stringify(config, null, 2));
         return configPath;
       }
       ```
       Import os, path, writeFileSync, fileURLToPath as needed.

    3. Update queryClaudeCode to add --mcp-config flag:
       - Call writeMcpConfigFile() once at start of function
       - Add to args array: '--mcp-config', mcpConfigPath
       - Consider cleanup: config file is small, can leave in /tmp

    4. Keep all existing functionality:
       - --dangerously-skip-permissions
       - -p prompt
       - --output-format json
       - --append-system-prompt
       - --model (if provided)
       - cwd set to KLAUSBOT_HOME
       - stdio: ['inherit', 'pipe', 'pipe']

  </action>
  <verify>
    - TypeScript compiles: `npx tsc --noEmit`
    - Build succeeds: `npm run build`
    - Config file written to temp dir contains valid JSON with mcpServers.klausbot
  </verify>
  <done>Spawner passes --mcp-config to Claude CLI with klausbot MCP server</done>
</task>

<task type="auto">
  <name>Task 2: Remove cron CLI instructions from system prompt</name>
  <files>src/memory/context.ts</files>
  <action>
    1. In getRetrievalInstructions(), locate the "Managing Scheduled Tasks (Cron Jobs)" section.
       This section currently documents the klausbot cron CLI commands.

    2. Remove the entire cron CLI section (lines ~188-237 approx):
       - "## Managing Scheduled Tasks (Cron Jobs)" header
       - All CLI command examples (klausbot cron add, list, delete, update)
       - Schedule formats documentation
       - Workflow instructions
       - Intent recognition examples

    3. Replace with brief MCP tools note (optional, Claude discovers tools automatically):
       ```
       ## Scheduled Tasks

       Use the MCP tools to manage scheduled tasks:
       - mcp__klausbot__create_cron - Create a new scheduled task
       - mcp__klausbot__list_crons - List existing tasks for a chat
       - mcp__klausbot__delete_cron - Remove a scheduled task

       The current chat ID is provided in <session-context>. Use this chatId for cron operations.
       ```

       OR simply delete the section entirely - MCP tools are self-describing via their descriptions.
       The leaner approach is preferred (delete without replacement).

    4. Keep all other sections unchanged:
       - Read Context Before Responding
       - Working Directory
       - Available Files
       - Retrieval Workflow
       - Semantic Search
       - Learning and Memory
       - Identity Updates
       - Learning from Past Mistakes
       - Proactive Improvement Suggestions
       - NEVER Expose Internal Details
       - DO NOT Proactively Ask About

  </action>
  <verify>
    - TypeScript compiles: `npx tsc --noEmit`
    - Grep for "klausbot cron" in context.ts returns no results
    - System prompt still contains memory/identity instructions
  </verify>
  <done>Cron CLI instructions removed from system prompt</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    MCP cron tools integrated with Claude spawner:
    - MCP server with create_cron, list_crons, delete_cron tools
    - Spawner passes --mcp-config to Claude CLI
    - System prompt no longer contains CLI cron instructions
  </what-built>
  <how-to-verify>
    1. Build the project: `npm run build`

    2. Start the gateway: `npm start`

    3. Send a message to the Telegram bot asking to create a cron:
       "Remind me every day at 9am to check my email"

    4. Verify Claude uses MCP tool (check logs for tool call or observe behavior)

    5. Ask "What are my scheduled tasks?" - verify it lists the cron

    6. Ask "Delete the email reminder" - verify deletion works

    7. Test existing functionality still works:
       - Memory: Ask "what did we discuss?" (should recall recent messages)
       - Identity: Check personality is consistent
       - Skills: Verify skills folder reminder appears

  </how-to-verify>
  <resume-signal>Type "approved" if cron tools work via MCP, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
1. Spawner generates MCP config with path to dist/mcp-server/index.js
2. Spawner passes --mcp-config flag to Claude CLI
3. Cron CLI section removed from system prompt
4. Build succeeds without errors
5. End-to-end: Claude creates/lists/deletes crons via MCP tools
6. Existing features (memory, identity, skills) unaffected
</verification>

<success_criteria>

- Claude calls mcp**klausbot**create_cron (not klausbot cron add)
- Claude calls mcp**klausbot**list_crons (not klausbot cron list)
- Claude calls mcp**klausbot**delete_cron (not klausbot cron delete)
- Phase 5.1 success criteria from ROADMAP.md all met:
  1. Typed MCP tool calls (not CLI string construction)
  2. MCP server via stdio transport
  3. Config passed via --mcp-config flag
  4. Existing functionality preserved
  5. Cron CLI instructions removed from system prompt
     </success_criteria>

<output>
After completion, create `.planning/phases/05.1-mcp-cron/05.1-02-SUMMARY.md`
</output>
