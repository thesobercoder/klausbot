---
phase: 05.1-mcp-cron
plan: 02
subsystem: daemon-spawner
tags: [mcp, spawner, integration, cron]

dependency-graph:
  requires: [05.1-01-mcp-server]
  provides: [mcp-cron-integration]
  affects: []

tech-stack:
  added: []
  patterns:
    - "MCP config via --mcp-config flag"
    - "Temp file for CLI config passing"
    - "Path resolution for bundled ESM"

key-files:
  created: []
  modified:
    - src/daemon/spawner.ts
    - src/memory/context.ts

decisions:
  - "Remove cron CLI instructions entirely (MCP tools self-describing)"
  - "Write MCP config to temp file per process (process.pid suffix)"
  - "Fixed path resolution for tsup bundling (./mcp-server not ../mcp-server)"

metrics:
  duration: "continuation after checkpoint fix"
  completed: "2026-01-30"
---

# Phase 5.1 Plan 02: CLI Spawner MCP Integration Summary

Integrated MCP server with CLI spawner, enabling typed tool calls for cron management.

## What Was Built

### MCP Config Generation
- `getMcpConfig()`: Returns config object with klausbot MCP server spec
- `writeMcpConfigFile()`: Writes config to /tmp/klausbot-mcp-{pid}.json
- Spawner passes `--mcp-config` flag to Claude CLI

### System Prompt Cleanup
- Removed 50-line "Managing Scheduled Tasks (Cron Jobs)" section
- MCP tools are self-describing via tool descriptions
- Leaner system prompt, less instruction duplication

## Key Implementation Details

**Path resolution fix:** Original code assumed `import.meta.url` resolves to `dist/daemon/spawner.js`, but tsup bundles into flat `dist/index.js`. Fixed path from `../mcp-server/index.js` to `mcp-server/index.js`.

**MCP config format:**
```json
{
  "mcpServers": {
    "klausbot": {
      "command": "node",
      "args": ["/path/to/dist/mcp-server/index.js"],
      "env": {}
    }
  }
}
```

**Tool naming convention:** Claude CLI prefixes MCP tools as `mcp__{server}__{tool}`:
- `mcp__klausbot__create_cron`
- `mcp__klausbot__list_crons`
- `mcp__klausbot__delete_cron`

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Fixed MCP server path resolution**

- **Found during:** Checkpoint debugging (Task 3)
- **Issue:** User reported "cannot find any cron tools". Path resolved to non-existent `/path/mcp-server/index.js` instead of `/path/dist/mcp-server/index.js`
- **Root cause:** Code assumed tsup preserves directory structure (`dist/daemon/spawner.js`), but tsup bundles to flat `dist/index.js`
- **Fix:** Changed `'../mcp-server/index.js'` to `'mcp-server/index.js'`
- **Files modified:** src/daemon/spawner.ts
- **Commit:** 1d982c4

## Verification Results

| Check | Status |
|-------|--------|
| TypeScript compiles | PASS |
| Build succeeds | PASS |
| MCP config JSON valid | PASS |
| dist/mcp-server/index.js exists | PASS |
| MCP server responds to tools/list | PASS |
| Claude CLI sees MCP tools | PASS |
| Cron CLI removed from system prompt | PASS |

**End-to-end test:**
```bash
claude --mcp-config /tmp/test-mcp-config.json -p "list your available MCP tools"
```
Response confirmed three tools: `mcp__klausbot__create_cron`, `mcp__klausbot__list_crons`, `mcp__klausbot__delete_cron`

## Commits

| Hash | Type | Description |
|------|------|-------------|
| 959ca4f | feat | Add MCP config generation and --mcp-config flag |
| 5cd36b8 | refactor | Remove cron CLI instructions from system prompt |
| 1d982c4 | fix | Correct MCP server path for tsup bundling |

## Phase 5.1 Completion

All Phase 5.1 success criteria met:

1. Typed MCP tool calls (not CLI string construction)
2. MCP server via stdio transport
3. Config passed via --mcp-config flag
4. Existing functionality preserved
5. Cron CLI instructions removed from system prompt
