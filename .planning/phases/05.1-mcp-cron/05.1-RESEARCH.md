# Phase 5.1: MCP Cron Tools - Research

**Researched:** 2026-01-30 (revised after Agent SDK pivot)
**Domain:** MCP server development, CLI spawner integration
**Confidence:** HIGH

## Summary

Phase 5.1 adds typed MCP tools for cron management. Instead of Claude parsing natural language and constructing CLI commands, it calls structured MCP tools directly.

**Approach:** Standalone MCP server (stdio transport) + CLI spawner with `--mcp-config` flag.

**Why not Agent SDK:** The `query()` function hangs indefinitely. SDK is a black box with unclear tool coverage. CLI spawner is proven reliable.

## Architecture

```
Gateway
  │
  └─► spawner.ts (child_process)
        │
        ├─► claude --mcp-config mcp.json --output-format stream-json
        │     │
        │     └─► klausbot-mcp (stdio subprocess)
        │           └─► cron tools
        │
        └─► parse stream-json responses
```

**Key CLI flags:**
- `--mcp-config <path>` — Load MCP server config
- `--output-format stream-json` — Stream responses (already using)
- `--strict-mcp-config` — Only use specified MCP servers (optional)

Note: `--allowedTools` not needed in bypass permissions mode.

## MCP Server Config Format

```json
{
  "mcpServers": {
    "klausbot": {
      "command": "node",
      "args": ["dist/mcp-server.js"],
      "env": {}
    }
  }
}
```

Tool naming convention: `mcp__<server-name>__<tool-name>`
- `mcp__klausbot__create_cron`
- `mcp__klausbot__list_crons`
- `mcp__klausbot__delete_cron`

## MCP Server Implementation

Using `@modelcontextprotocol/sdk` for stdio transport:

```typescript
import { McpServer } from "@modelcontextprotocol/sdk/server/mcp.js";
import { StdioServerTransport } from "@modelcontextprotocol/sdk/server/stdio.js";
import { z } from "zod";

const server = new McpServer({
  name: "klausbot",
  version: "1.0.0",
});

server.tool(
  "create_cron",
  "Create a scheduled task",
  {
    name: z.string().describe("Job name"),
    schedule: z.string().describe("Cron expression or natural language"),
    instruction: z.string().describe("What to do when job runs"),
    chatId: z.number().describe("Telegram chat ID"),
  },
  async ({ name, schedule, instruction, chatId }) => {
    // Call cron service
    const job = await createCronJob({ name, schedule, instruction, chatId });
    return {
      content: [{ type: "text", text: `Created job ${job.id}` }],
    };
  }
);

// Start server
const transport = new StdioServerTransport();
await server.connect(transport);
```

## Spawner Changes

Update `spawner.ts` to pass MCP config:

```typescript
const args = [
  '-p', prompt,
  '--output-format', 'stream-json',
  '--mcp-config', getMcpConfigPath(),
  // No --allowedTools needed in bypass permissions mode
];

const claude = spawn('claude', args, { ... });
```

## What Changes from Current

| Current | New |
|---------|-----|
| Cron instructions in system prompt | MCP tools (typed) |
| Claude constructs CLI commands | Claude calls MCP tools directly |
| Error-prone string parsing | Zod-validated parameters |
| No tool discoverability | Tools listed in MCP handshake |

## What Stays the Same

- CLI spawner (child_process)
- `--output-format stream-json`
- Bypass permissions mode
- Telegram response delivery
- Cron service implementation (just add MCP wrapper)

## File Structure

```
src/
  mcp-server/
    index.ts       # Entry point, stdio transport
    tools/
      cron.ts      # Cron tool definitions
  daemon/
    spawner.ts     # Updated with --mcp-config
config/
  mcp.json         # MCP server config (generated or static)
```

## Dependencies

Only need MCP SDK for the standalone server:

```bash
npm install @modelcontextprotocol/sdk
```

No Agent SDK required. Zod already installed.

## Open Questions

1. **Config file location**
   - Option A: Static file in repo (`config/mcp.json`)
   - Option B: Generate at runtime with absolute paths
   - Recommendation: Generate at runtime (paths vary by install)

2. **MCP server process lifecycle**
   - Spawned per-query (clean state) vs long-running
   - Recommendation: Let Claude CLI manage it (spawned per session)

3. **Hooks for capturing tool calls**
   - Can use `--hooks` CLI flag for custom behavior
   - Potential use: Log MCP tool calls, capture checkpoints

## Sources

- [MCP TypeScript SDK](https://github.com/modelcontextprotocol/typescript-sdk)
- [MCP Build Server Guide](https://modelcontextprotocol.io/docs/develop/build-server)
- Claude CLI `--help` output (verified 2026-01-30)

## Metadata

**Confidence:** HIGH - Using proven CLI spawner + standard MCP patterns
**Research date:** 2026-01-30
**Valid until:** 2026-03-30
