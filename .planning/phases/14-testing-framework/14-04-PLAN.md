---
phase: 14-testing-framework
plan: 04
type: execute
wave: 3
depends_on: ["14-02", "14-03", "14-05"]
files_modified:
  - .github/workflows/ci.yml
  - package.json
autonomous: true

must_haves:
  truths:
    - "CI pipeline runs typecheck, format check, lint, and tests on every push and PR"
    - "CI pipeline reports test coverage"
    - "npm run check and npm test both pass in CI environment"
  artifacts:
    - path: ".github/workflows/ci.yml"
      provides: "GitHub Actions CI workflow"
      contains: "npm test"
    - path: "package.json"
      provides: "Updated check script including tests"
      contains: "test"
  key_links:
    - from: ".github/workflows/ci.yml"
      to: "package.json"
      via: "npm run check and npm test commands"
      pattern: "npm (run check|test)"
---

<objective>
Create GitHub Actions CI workflow that runs the full check suite (typecheck + format + lint + tests) on every push and PR to main.

Purpose: TEST-04 requirement. "Tests pass = app works" confidence requires automated CI enforcement.
Output: .github/workflows/ci.yml, updated package.json check script
</objective>

<execution_context>
@/home/soham/.claude/get-shit-done/workflows/execute-plan.md
@/home/soham/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-testing-framework/14-RESEARCH.md
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitHub Actions CI workflow</name>
  <files>.github/workflows/ci.yml</files>
  <action>
Create `.github/workflows/ci.yml` with:

```yaml
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
      - run: npm ci
      - name: Typecheck + Format + Lint
        run: npm run check
      - name: Tests
        run: npm test
      - name: Coverage
        run: npm run test:coverage
```

Key decisions:
- Node 22 (matches engines field in package.json)
- `npm ci` for deterministic installs (uses package-lock.json)
- Separate named steps for check vs test for clear failure identification
- Coverage runs as a separate step (informational, not gating) — thresholds in vitest.config.ts will fail the step if not met
- Do NOT install Claude CLI or sqlite-vec native extension — all tests mock external boundaries
- Do NOT set TELEGRAM_BOT_TOKEN or other env vars — tests don't need them (mocked)

Create the `.github/workflows/` directory if it doesn't exist.
  </action>
  <verify>
   - File exists at `.github/workflows/ci.yml`
   - YAML is valid: `npx yaml-lint .github/workflows/ci.yml 2>/dev/null || python3 -c "import yaml; yaml.safe_load(open('.github/workflows/ci.yml'))"` (use whichever is available)
   - Alternatively, just read the file and verify structure manually
  </verify>
  <done>CI workflow created. Runs typecheck, format, lint, tests, and coverage on push/PR to main.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate tests into check pipeline and verify full suite</name>
  <files>package.json</files>
  <action>
1. Update package.json scripts to add test step to the check pipeline:
   - Add `"check:test": "vitest run"` to scripts
   - This makes `npm run check` run typecheck + format + lint + tests (via run-s check:*)
   - The alphabetical ordering of check:* means check:test runs after check:typecheck — which is correct (typecheck first, then test)

2. Run the full validation suite locally to confirm everything passes:
   ```
   npm run format
   npm run check
   ```

   This is the pre-commit checklist from CLAUDE.md. Both must pass clean.

3. Also run test with coverage to verify thresholds:
   ```
   npm run test:coverage
   ```

   If coverage thresholds fail (the 40% targets from vitest.config.ts), either:
   a. Lower thresholds slightly to match actual coverage (acceptable for initial setup), OR
   b. The P0 + P1 tests should push past 40% — verify and adjust if needed

4. Run `npm run format` to ensure all new test files are formatted correctly.
  </action>
  <verify>
   - `npm run check` passes (includes typecheck, format, lint, AND tests)
   - `npm run test:coverage` shows coverage report and passes threshold check
   - `npm test` independently passes
  </verify>
  <done>Full CI pipeline integrated. `npm run check` now includes tests. Coverage thresholds met. Pre-commit checklist passes.</done>
</task>

</tasks>

<verification>
- `npm run check` passes clean (typecheck + format + lint + tests)
- `npm run test:coverage` reports coverage >= 40% statements on tested modules
- `.github/workflows/ci.yml` exists with correct structure
- All pre-commit checks pass: `npm run format && npm run check`
</verification>

<success_criteria>
1. GitHub Actions CI workflow runs all checks on push/PR
2. `npm run check` includes tests in the pipeline
3. Coverage thresholds enforced (40% statements minimum)
4. Full pipeline passes locally before commit
</success_criteria>

<output>
After completion, create `.planning/phases/14-testing-framework/14-04-SUMMARY.md`
</output>
