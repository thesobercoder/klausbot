---
phase: 05.1-mcp-cron
plan: 02
subsystem: daemon-spawner
tags: [mcp, spawner, integration, cron]

dependency-graph:
  requires: [05.1-01-mcp-server]
  provides: [mcp-cron-integration]
  affects: []

tech-stack:
  added: []
  patterns:
    - "MCP config via --mcp-config flag"
    - "Temp file for CLI config passing"
    - "Path resolution for bundled ESM"

key-files:
  created: []
  modified:
    - src/daemon/spawner.ts
    - src/memory/context.ts

decisions:
  - "Remove cron CLI instructions entirely (MCP tools self-describing)"
  - "Write MCP config to temp file per process (process.pid suffix)"
  - "Use `klausbot mcp` subcommand (consistent with project philosophy)"
  - "Use process.argv for invocation (works in dev and production)"

metrics:
  duration: "continuation after checkpoint fix"
  completed: "2026-01-30"
---

# Phase 5.1 Plan 02: CLI Spawner MCP Integration Summary

Integrated MCP server with CLI spawner, enabling typed tool calls for cron management.

## What Was Built

### MCP Config Generation
- `getMcpConfig()`: Returns config object with klausbot MCP server spec
- `writeMcpConfigFile()`: Writes config to /tmp/klausbot-mcp-{pid}.json
- Spawner passes `--mcp-config` flag to Claude CLI

### System Prompt Cleanup
- Removed 50-line "Managing Scheduled Tasks (Cron Jobs)" section
- MCP tools are self-describing via tool descriptions
- Leaner system prompt, less instruction duplication

## Key Implementation Details

**CLI subcommand:** MCP server runs via `klausbot mcp` subcommand, consistent with project philosophy of everything through one CLI.

**Dynamic invocation:** Uses `process.argv[0]` and `process.argv[1]` to mirror how the current process was invoked:
- Dev: `node dist/index.js` → MCP uses `node dist/index.js mcp`
- Prod: `klausbot` → MCP uses `node /path/to/bin mcp`

**MCP config format:**
```json
{
  "mcpServers": {
    "klausbot": {
      "command": "node",
      "args": ["/path/to/dist/index.js", "mcp"],
      "env": {}
    }
  }
}
```

**Tool naming convention:** Claude CLI prefixes MCP tools as `mcp__{server}__{tool}`:
- `mcp__klausbot__create_cron`
- `mcp__klausbot__list_crons`
- `mcp__klausbot__delete_cron`

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Refactored to CLI subcommand**

- **Found during:** Checkpoint debugging (Task 3)
- **Issue:** User reported "cannot find any cron tools" and noted separate node invocation violated project philosophy
- **Root cause:** Original plan used `node dist/mcp-server/index.js` directly instead of CLI subcommand
- **Fix:** Added `klausbot mcp` subcommand, removed separate tsup entry, use `process.argv` for dynamic invocation
- **Files modified:** src/index.ts, src/daemon/spawner.ts, src/mcp-server/index.ts, tsup.config.ts
- **Commits:** 91cd9d8, 46e914b, 0a16555

## Verification Results

| Check | Status |
|-------|--------|
| TypeScript compiles | PASS |
| Build succeeds (single entry point) | PASS |
| `klausbot mcp` subcommand works | PASS |
| MCP server responds to initialize | PASS |
| Claude CLI sees MCP tools | PASS |
| Cron CLI removed from system prompt | PASS |
| E2E: create/list/delete crons via MCP | PASS |

**End-to-end test:** User verified in Telegram that Claude uses `mcp__klausbot__create_cron`, `mcp__klausbot__list_crons`, `mcp__klausbot__delete_cron` tools correctly.

## Commits

| Hash | Type | Description |
|------|------|-------------|
| 959ca4f | feat | Add MCP config generation and --mcp-config flag |
| 5cd36b8 | refactor | Remove cron CLI instructions from system prompt |
| 91cd9d8 | refactor | Use klausbot mcp-server subcommand |
| 46e914b | fix | Use process.argv for MCP server invocation |
| 0a16555 | refactor | Rename mcp-server subcommand to mcp |

## Phase 5.1 Completion

All Phase 5.1 success criteria met:

1. Typed MCP tool calls (not CLI string construction)
2. MCP server via stdio transport
3. Config passed via --mcp-config flag
4. Existing functionality preserved
5. Cron CLI instructions removed from system prompt
