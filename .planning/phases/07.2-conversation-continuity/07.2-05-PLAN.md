---
phase: 07.2-conversation-continuity
plan: 05
type: execute
wave: 4
depends_on: ["07.2-03", "07.2-04"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "SessionStart injects datetime and recent summaries into Claude context"
    - "SessionEnd stores conversation with summary in SQLite"
    - "search_memories finds conversations and embeddings"
    - "get_conversation retrieves full transcript"
    - "Markdown logger no longer writes conversation files"
  artifacts: []
  key_links: []
---

<objective>
End-to-end verification of conversation continuity system.

Purpose: Confirm all components work together in production
Output: Verified working system with conversation history search
</objective>

<execution_context>
@/home/soham/.claude/get-shit-done/workflows/execute-plan.md
@/home/soham/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07.2-conversation-continuity/07.2-01-SUMMARY.md
@.planning/phases/07.2-conversation-continuity/07.2-02-SUMMARY.md
@.planning/phases/07.2-conversation-continuity/07.2-03-SUMMARY.md
@.planning/phases/07.2-conversation-continuity/07.2-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify build and startup</name>
  <files></files>
  <action>
1. Fresh build:
   ```bash
   npm run build
   ```

2. Start gateway and verify logs:
   ```bash
   npx tsx src/index.ts daemon
   ```

   Check for:
   - "Database migrations complete"
   - "Cron scheduler initialized"
   - "Gateway running"

   Ctrl+C to stop.

3. Verify no markdown conversation files created:
   ```bash
   ls -la ~/.klausbot/conversations/ 2>/dev/null || echo "No conversations dir (expected)"
   ```
  </action>
  <verify>Gateway starts without errors, no markdown files created</verify>
  <done>Build and startup verified</done>
</task>

<task type="auto">
  <name>Task 2: Verify database schema</name>
  <files></files>
  <action>
Check SQLite database has correct tables:

```bash
sqlite3 ~/.klausbot/klausbot.db ".tables"
```

Expected output should include:
- conversations
- conversation_embeddings
- embeddings
- vec_embeddings

Check conversations table schema:
```bash
sqlite3 ~/.klausbot/klausbot.db ".schema conversations"
```

Should show session_id, started_at, ended_at, transcript, summary, message_count, chat_id columns.
  </action>
  <verify>Tables exist with correct schema</verify>
  <done>Database schema verified</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete conversation continuity system:
- Hook CLI commands (klausbot hook start|compact|end)
- Drizzle ORM with conversations table
- SessionStart context injection (datetime + summaries)
- SessionEnd transcript storage with AI summary
- search_memories MCP tool (embeddings + conversations)
- get_conversation MCP tool
  </what-built>
  <how-to-verify>
**Full End-to-End Test (via Telegram):**

1. Start gateway:
   ```bash
   npx tsx src/index.ts daemon
   ```

2. Send a message to your bot via Telegram (something memorable):
   "Let's talk about planning a trip to Japan. I'm thinking of visiting Tokyo and Kyoto in spring."

3. Wait for response. After response, check logs for:
   - `[hook:end] session=...` in stderr output
   - `Stored conversation: X messages, summary: ...`

4. Check database:
   ```bash
   sqlite3 ~/.klausbot/klausbot.db "SELECT session_id, summary, message_count FROM conversations ORDER BY ended_at DESC LIMIT 3"
   ```
   Should show your conversation with an AI-generated summary.

5. Test search via second message:
   "Search your memories for our discussion about travel"

   Claude should find the previous conversation using search_memories.

6. Verify no markdown logs:
   ```bash
   ls ~/.klausbot/conversations/
   ```
   Should be empty or not exist (old files may remain from before Phase 7.2).

7. Test context injection by asking:
   "What conversations have we had recently?"

   Claude should have access to summaries via SessionStart context.

**Alternative: CLI Hook Test (if Telegram not available):**

1. Create test transcript file:
   ```bash
   cat > /tmp/test-transcript.jsonl << 'EOF'
   {"type":"user","timestamp":"2026-01-31T10:00:00Z","message":{"content":[{"type":"text","text":"Hello, how are you?"}]}}
   {"type":"assistant","timestamp":"2026-01-31T10:00:05Z","message":{"content":[{"type":"text","text":"I'm doing well! How can I help you today?"}]}}
   EOF
   ```

2. Test hooks:
   ```bash
   # SessionStart
   echo '{"session_id":"test-123","transcript_path":"/tmp/test-transcript.jsonl","cwd":"/tmp","hook_event_name":"SessionStart"}' | npx tsx src/index.ts hook start

   # SessionEnd
   echo '{"session_id":"test-123","transcript_path":"/tmp/test-transcript.jsonl","cwd":"/tmp","hook_event_name":"SessionEnd"}' | npx tsx src/index.ts hook end
   ```

3. Verify storage:
   ```bash
   sqlite3 ~/.klausbot/klausbot.db "SELECT session_id, summary FROM conversations WHERE session_id='test-123'"
   ```
  </how-to-verify>
  <resume-signal>Type "verified" if all tests pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
All checks from human verification task pass:
1. Gateway starts with database migrations
2. Hook CLI commands work
3. Conversations stored in SQLite with summaries
4. search_memories finds conversation history
5. get_conversation retrieves transcripts
6. No markdown conversation files created
</verification>

<success_criteria>
Phase 7.2 complete when human confirms:
- SessionStart injects context (datetime + recent summaries)
- SessionEnd stores transcript with AI-generated summary
- search_memories searches both embeddings and conversations
- get_conversation retrieves full transcript
- Markdown logger no longer active
</success_criteria>

<output>
After completion, create `.planning/phases/07.2-conversation-continuity/07.2-05-SUMMARY.md`
</output>
