---
phase: 12-heartbeat-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/config/schema.ts
  - src/heartbeat/index.ts
  - src/heartbeat/scheduler.ts
  - src/heartbeat/executor.ts
autonomous: true

must_haves:
  truths:
    - "Heartbeat config schema accepts enabled (bool) and intervalMs (number)"
    - "Scheduler starts/stops interval loop without immediate tick"
    - "Executor invokes Claude with heartbeat prompt and 5min timeout"
    - "HEARTBEAT_OK response suppresses Telegram message"
    - "Non-OK response sends to all approved users"
  artifacts:
    - path: "src/config/schema.ts"
      provides: "heartbeat config in jsonConfigSchema"
      contains: "heartbeat:"
    - path: "src/heartbeat/scheduler.ts"
      provides: "startHeartbeat, stopHeartbeat functions"
      exports: ["startHeartbeat", "stopHeartbeat"]
    - path: "src/heartbeat/executor.ts"
      provides: "executeHeartbeat function with HEARTBEAT_OK parsing"
      exports: ["executeHeartbeat"]
    - path: "src/heartbeat/index.ts"
      provides: "Re-exports for heartbeat module"
      exports: ["startHeartbeat", "stopHeartbeat", "executeHeartbeat"]
  key_links:
    - from: "src/heartbeat/scheduler.ts"
      to: "src/config/index.js"
      via: "getJsonConfig import"
      pattern: "getJsonConfig"
    - from: "src/heartbeat/executor.ts"
      to: "src/daemon/spawner.ts"
      via: "queryClaudeCode import"
      pattern: "queryClaudeCode"
    - from: "src/heartbeat/executor.ts"
      to: "src/pairing/store.ts"
      via: "getPairingStore for approved users"
      pattern: "getPairingStore"
---

<objective>
Create heartbeat core infrastructure: config schema, scheduler loop, and executor with HEARTBEAT_OK suppression.

Purpose: Foundation for periodic awareness system - scheduler provides timing, executor handles Claude invocation and response parsing.
Output: Heartbeat module ready for gateway integration.
</objective>

<execution_context>
@/home/soham/.claude/get-shit-done/workflows/execute-plan.md
@/home/soham/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-heartbeat-system/12-CONTEXT.md
@.planning/phases/12-heartbeat-system/12-RESEARCH.md

# Existing patterns to follow

@src/cron/scheduler.ts
@src/daemon/spawner.ts
@src/config/schema.ts
@src/pairing/store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend config schema with heartbeat settings</name>
  <files>src/config/schema.ts</files>
  <action>
Add heartbeat config to jsonConfigSchema in the existing .object() chain:

```typescript
heartbeat: z
  .object({
    /** Enable heartbeat checks (default: true) */
    enabled: z.boolean().default(true),
    /** Interval between checks in ms (min 60000, default 1800000 = 30 min) */
    intervalMs: z.number().min(60000).default(1800000),
  })
  .default({ enabled: true, intervalMs: 1800000 }),
```

Place after the streaming config, before `.strict()`.

Update JsonConfig type comment to mention heartbeat.
</action>
<verify>
`npx tsc --noEmit` passes.
`grep -A5 "heartbeat:" src/config/schema.ts` shows new schema.
</verify>
<done>
jsonConfigSchema includes heartbeat with enabled (bool, default true) and intervalMs (number, min 60000, default 1800000).
</done>
</task>

<task type="auto">
  <name>Task 2: Create heartbeat scheduler module</name>
  <files>src/heartbeat/scheduler.ts</files>
  <action>
Create src/heartbeat/ directory and scheduler.ts.

Pattern: Follow cron/scheduler.ts but simpler (no queue, no recovery).

```typescript
/**
 * Heartbeat scheduler - periodic awareness checks
 * Waits for first interval (no immediate tick per CONTEXT.md)
 */

import { getJsonConfig } from "../config/index.js";
import { executeHeartbeat } from "./executor.js";
import { createChildLogger } from "../utils/index.js";

const log = createChildLogger("heartbeat");

let heartbeatInterval: NodeJS.Timeout | null = null;
let isExecuting = false;

/**
 * Start the heartbeat scheduler
 * Checks config.heartbeat.enabled before starting
 * Does NOT run immediately - waits for first interval
 */
export function startHeartbeat(): void {
  if (heartbeatInterval) {
    log.warn("Heartbeat already running");
    return;
  }

  const config = getJsonConfig();
  if (!config.heartbeat?.enabled) {
    log.info("Heartbeat disabled in config");
    return;
  }

  const intervalMs = config.heartbeat.intervalMs ?? 1800000;

  // NO immediate tick() - wait for first interval per CONTEXT.md
  heartbeatInterval = setInterval(tick, intervalMs);
  log.info({ intervalMs }, "Heartbeat scheduler started");
}

/**
 * Stop the heartbeat scheduler
 */
export function stopHeartbeat(): void {
  if (heartbeatInterval) {
    clearInterval(heartbeatInterval);
    heartbeatInterval = null;
    log.info("Heartbeat scheduler stopped");
  }
}

/**
 * Scheduler tick - execute heartbeat check
 * Prevents concurrent execution
 * Re-checks config for hot reload support
 */
async function tick(): Promise<void> {
  // Prevent concurrent execution
  if (isExecuting) {
    log.debug("Heartbeat already executing, skipping");
    return;
  }

  // Re-check config (hot reload support)
  const config = getJsonConfig();
  if (!config.heartbeat?.enabled) {
    log.info("Heartbeat disabled via hot reload, stopping");
    stopHeartbeat();
    return;
  }

  isExecuting = true;
  try {
    await executeHeartbeat();
  } catch (err) {
    log.error({ err }, "Heartbeat tick error");
  } finally {
    isExecuting = false;
  }
}
```

Key differences from cron scheduler:

- No job queue (single heartbeat)
- No missed job recovery
- No immediate tick on start
- Hot reload support via config re-check
  </action>
  <verify>
  `npx tsc --noEmit` passes (after executor.ts exists - verify at end of plan).
  File exists: `ls src/heartbeat/scheduler.ts`
  </verify>
  <done>
  Scheduler module with startHeartbeat/stopHeartbeat exports, setInterval loop, concurrent execution prevention, hot reload support.
  </done>
  </task>

<task type="auto">
  <name>Task 3: Create heartbeat executor module</name>
  <files>src/heartbeat/executor.ts, src/heartbeat/index.ts</files>
  <action>
Create executor.ts with Claude invocation and HEARTBEAT_OK suppression.

```typescript
/**
 * Heartbeat executor - Claude invocation and response handling
 * Sends non-OK responses to all approved users
 */

import { existsSync, readFileSync, writeFileSync } from "fs";
import { queryClaudeCode } from "../daemon/spawner.js";
import { getPairingStore } from "../pairing/index.js";
import { getHomePath } from "../memory/index.js";
import { createChildLogger } from "../utils/index.js";
import { markdownToTelegramHtml } from "../utils/markdown.js";

const log = createChildLogger("heartbeat-executor");

/** Exact response string that suppresses notification */
const HEARTBEAT_OK = "HEARTBEAT_OK";

/** Timeout for heartbeat check (5 minutes, per CONTEXT.md) */
const HEARTBEAT_TIMEOUT = 300000;

/** Template for auto-created HEARTBEAT.md */
const HEARTBEAT_TEMPLATE = `# Heartbeat Reminders

Things to check and remember during periodic heartbeat checks.

## Format

Add items with optional expiry dates:
- [ ] Check something [expires: 2026-02-15]
- [ ] Recurring reminder (no expiry = permanent)

## Active Items

(No items yet)
`;

/** Result of heartbeat execution */
export interface HeartbeatResult {
  ok: boolean;
  suppressed: boolean;
  response?: string;
  error?: string;
}

/**
 * Get path to HEARTBEAT.md file
 */
export function getHeartbeatPath(): string {
  return getHomePath("HEARTBEAT.md");
}

/**
 * Ensure HEARTBEAT.md exists, create with template if missing
 */
function ensureHeartbeatFile(): void {
  const heartbeatPath = getHeartbeatPath();
  if (!existsSync(heartbeatPath)) {
    writeFileSync(heartbeatPath, HEARTBEAT_TEMPLATE);
    log.info({ path: heartbeatPath }, "Created HEARTBEAT.md template");
  }
}

/**
 * Build heartbeat prompt for Claude
 */
function buildHeartbeatPrompt(heartbeatContent: string): string {
  const now = new Date().toISOString();
  return `<heartbeat-check>
Current time: ${now}

Review your HEARTBEAT.md reminders below and take appropriate action:

<heartbeat-file>
${heartbeatContent}
</heartbeat-file>

Instructions:
1. Read each item and decide if action is needed
2. For expired items: remove them from the file
3. For actionable items: execute using tools (check email, call APIs, etc.)
4. If nothing requires attention: respond with exactly "HEARTBEAT_OK"
5. If anything needs user attention: respond with a combined summary

You have full tool access. Take actions, don't just report.
</heartbeat-check>`;
}

/**
 * Execute heartbeat check
 * - Reads HEARTBEAT.md (auto-creates if missing)
 * - Invokes Claude with heartbeat prompt
 * - Suppresses HEARTBEAT_OK response
 * - Sends non-OK responses to all approved users
 */
export async function executeHeartbeat(): Promise<HeartbeatResult> {
  log.info("Starting heartbeat check");

  // Ensure HEARTBEAT.md exists
  ensureHeartbeatFile();

  // Read heartbeat file
  const heartbeatPath = getHeartbeatPath();
  const heartbeatContent = readFileSync(heartbeatPath, "utf-8");

  // Build prompt
  const prompt = buildHeartbeatPrompt(heartbeatContent);

  try {
    // Invoke Claude with timeout
    const response = await queryClaudeCode(prompt, {
      timeout: HEARTBEAT_TIMEOUT,
    });

    const result = response.result.trim();

    // Check for HEARTBEAT_OK (exact match after trim)
    if (result === HEARTBEAT_OK) {
      log.info("Heartbeat OK - nothing to report");
      return { ok: true, suppressed: true };
    }

    // Non-OK response - send to all approved users
    log.info(
      { responseLength: result.length },
      "Heartbeat has items to report",
    );

    // Get bot instance dynamically (avoid circular import)
    const { bot } = await import("../telegram/index.js");

    // Get all approved users
    const store = getPairingStore();
    const approved = store.listApproved();

    if (approved.length === 0) {
      log.warn("No approved users to send heartbeat to");
      return { ok: true, suppressed: false, response: result };
    }

    // Format message with [Heartbeat] prefix
    const message = `[Heartbeat]\n${markdownToTelegramHtml(result)}`;

    // Send to each approved user
    for (const user of approved) {
      try {
        await bot.api.sendMessage(user.chatId, message, { parse_mode: "HTML" });
        log.debug({ chatId: user.chatId }, "Sent heartbeat to user");
      } catch (err) {
        log.error(
          { err, chatId: user.chatId },
          "Failed to send heartbeat to user",
        );
      }
    }

    return { ok: true, suppressed: false, response: result };
  } catch (err) {
    const errorMsg = err instanceof Error ? err.message : String(err);
    log.error({ err }, "Heartbeat execution failed");

    // Notify users of failure (per CONTEXT.md)
    try {
      const { bot } = await import("../telegram/index.js");
      const store = getPairingStore();
      const approved = store.listApproved();

      for (const user of approved) {
        try {
          await bot.api.sendMessage(
            user.chatId,
            `Heartbeat check failed: ${errorMsg}`,
          );
        } catch {
          // Ignore send errors
        }
      }
    } catch {
      // Ignore import/send errors
    }

    return { ok: false, suppressed: false, error: errorMsg };
  }
}
```

Create index.ts re-exports:

```typescript
/**
 * Heartbeat module - periodic awareness system
 */

export { startHeartbeat, stopHeartbeat } from "./scheduler.js";
export {
  executeHeartbeat,
  getHeartbeatPath,
  type HeartbeatResult,
} from "./executor.js";
```

  </action>
  <verify>
`npx tsc --noEmit` passes.
`ls src/heartbeat/` shows scheduler.ts, executor.ts, index.ts
`grep "HEARTBEAT_OK" src/heartbeat/executor.ts` shows suppression constant
  </verify>
  <done>
- Executor reads HEARTBEAT.md (auto-creates if missing)
- Invokes Claude with 5min timeout
- Exact HEARTBEAT_OK match suppresses notification
- Non-OK responses sent to all approved users via getPairingStore().listApproved()
- Failure notification sent per CONTEXT.md
- Index.ts re-exports all public functions
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Config schema extended: `grep -A8 "heartbeat:" src/config/schema.ts`
3. Module structure: `ls -la src/heartbeat/`
4. Exports available: `grep "export" src/heartbeat/index.ts`
</verification>

<success_criteria>

- [ ] jsonConfigSchema includes heartbeat.enabled (default true) and heartbeat.intervalMs (default 1800000, min 60000)
- [ ] startHeartbeat() creates setInterval without immediate tick
- [ ] stopHeartbeat() clears interval
- [ ] executeHeartbeat() invokes queryClaudeCode with 5min timeout
- [ ] HEARTBEAT_OK response returns { ok: true, suppressed: true }
- [ ] Non-OK response sends to all approved users with [Heartbeat] prefix
- [ ] TypeScript compiles without errors
      </success_criteria>

<output>
After completion, create `.planning/phases/12-heartbeat-system/12-01-SUMMARY.md`
</output>
