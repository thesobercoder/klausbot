# Phase 13.2: Subagent Orchestration - Research

**Researched:** 2026-02-05
**Domain:** Claude Code multi-agent orchestration, background processes, inter-process communication
**Confidence:** HIGH

## Summary

Claude Code has mature subagent orchestration built-in via the Task tool. Rather than building custom infrastructure, klausbot should leverage Claude Code's native capabilities.

**Key insight:** Claude Code's Task tool already enables spawning subagents, running them in background, coordinating via shared task lists, and collecting results. The main work is exposing these capabilities to klausbot's parent Claude instance through proper configuration.

**Primary recommendation:** Configure Claude Code invocations to enable Task tool with `--allowedTools "Task"`, use `CLAUDE_CODE_TASK_LIST_ID` for coordination, and add orchestration instructions to system prompt.

## Standard Stack

Claude Code's built-in orchestration requires no additional libraries.

### Core (Built-in to Claude Code)

| Component                | Version                        | Purpose                    | Source                                                                        |
| ------------------------ | ------------------------------ | -------------------------- | ----------------------------------------------------------------------------- |
| Task tool                | Claude Code 2.1+               | Spawn/manage subagents     | [Official docs](https://code.claude.com/docs/en/sub-agents)                   |
| CLAUDE_CODE_TASK_LIST_ID | 2.1.16+                        | Multi-session coordination | [Task management](https://claudefa.st/blog/guide/development/task-management) |
| Built-in subagents       | Explore, Plan, general-purpose | Pre-configured agent types | [Official docs](https://code.claude.com/docs/en/sub-agents)                   |
| /tasks command           | Interactive                    | Monitor background tasks   | [Async workflows](https://claudefa.st/blog/guide/agents/async-workflows)      |

### Supporting

| Component                         | Purpose                          | When to Use                       |
| --------------------------------- | -------------------------------- | --------------------------------- |
| Custom agents (`.claude/agents/`) | Specialized subagent definitions | When built-in agents insufficient |
| --agents CLI flag                 | Session-scoped agent definitions | Testing/automation                |
| Node.js child_process             | Process spawning for Claude CLI  | Already used in spawner.ts        |

### Alternatives Considered

| Instead of               | Could Use                      | Tradeoff                                                                             |
| ------------------------ | ------------------------------ | ------------------------------------------------------------------------------------ |
| Task tool                | Manual `spawn()` orchestration | Task tool provides context isolation, result collection, background support built-in |
| CLAUDE_CODE_TASK_LIST_ID | Custom file-based coordination | Native solution has real-time sync, persistence, multi-session support               |
| Node IPC                 | File-based messaging           | Complexity vs. simplicity; Task tool abstracts this                                  |

## Architecture Patterns

### How Task Tool Works

Claude Code's Task tool enables parent agents to spawn child agents:

```xml
<invoke name="Task">
  <parameter name="subagent_type">general-purpose</parameter>
  <parameter name="description">Research the authentication module</parameter>
  <parameter name="prompt">Analyze all auth-related code and document patterns</parameter>
  <parameter name="run_in_background">true</parameter>
  <parameter name="model">haiku</parameter>
</invoke>
```

Parameters:

- `subagent_type`: `general-purpose`, `Explore`, `Plan`, `Bash`, or custom agent name
- `description`: 3-5 word summary (used for logging/tracking)
- `prompt`: Full instructions for subagent
- `run_in_background`: `true` for async, `false` for blocking
- `model`: `sonnet`, `opus`, `haiku`, or `inherit`
- `resume`: Agent ID to continue interrupted work

### Context Isolation Model

```
Parent Claude Session (200K tokens)
    │
    ├── spawns → Subagent A (own 200K context)
    │              └── works independently
    │              └── returns summary only (preserves parent context)
    │
    └── spawns → Subagent B (own 200K context)
                   └── parallel execution
                   └── results collected when done
```

Each subagent:

- Gets its own 200K token context window
- Cannot spawn further subagents (single level)
- Only returns summary to parent (not full context)
- Can be run foreground (blocking) or background (async)

### Multi-Session Coordination via CLAUDE_CODE_TASK_LIST_ID

```bash
# Session 1 (parent)
CLAUDE_CODE_TASK_LIST_ID=klausbot-tasks claude -p "Coordinate work"

# Session 2 (child/parallel)
CLAUDE_CODE_TASK_LIST_ID=klausbot-tasks claude -p "Execute delegated task"
```

Task list stored at: `~/.claude/tasks/{task_list_id}/`

Both sessions see same task state, updates broadcast in real-time.

### Recommended klausbot Integration Architecture

```
┌─────────────────────────────────────────────────────────┐
│                   klausbot daemon                        │
│                                                          │
│  ┌──────────┐    ┌──────────────┐    ┌──────────────┐  │
│  │ gateway  │───▶│   spawner    │───▶│ Claude Code  │  │
│  └──────────┘    └──────────────┘    │  (parent)    │  │
│                                       │              │  │
│                                       │  uses Task   │  │
│                                       │  tool to     │  │
│                                       │  spawn       │  │
│                                       │  subagents   │  │
│                                       └──────────────┘  │
│                                              │          │
│                              ┌───────────────┼──────────┤
│                              │               │          │
│                              ▼               ▼          │
│                       ┌──────────┐    ┌──────────┐     │
│                       │ Subagent │    │ Subagent │     │
│                       │ (Explore)│    │ (custom) │     │
│                       └──────────┘    └──────────┘     │
│                              │               │          │
│                              └───────┬───────┘          │
│                                      ▼                  │
│                              Results returned           │
│                              to parent Claude           │
└─────────────────────────────────────────────────────────┘
```

### Configuration Changes Required

**1. Enable Task tool in spawner:**

```typescript
// spawner.ts - add Task to allowed tools
const args = [
  "--dangerously-skip-permissions",
  "--allowedTools",
  "Task,Read,Write,Edit,Bash,Glob,Grep,mcp__klausbot__*",
  // ... rest of args
];
```

**2. Set CLAUDE_CODE_TASK_LIST_ID in environment:**

```typescript
// spawner.ts - add to spawn env
const claude = spawn("claude", args, {
  env: {
    ...process.env,
    CLAUDE_CODE_TASK_LIST_ID: "klausbot-session",
  },
});
```

**3. Add orchestration instructions to system prompt:**

```typescript
// context.ts - new function
export function getOrchestrationInstructions(): string {
  return `<subagent-orchestration>
## Parallel Work with Subagents

You can spawn subagents for parallel work using the Task tool.

**When to use subagents:**
- Research/exploration that would pollute main context
- Parallel independent tasks
- Long-running operations
- Operations benefiting from specialized focus

**Available agent types:**
- Explore: Fast, read-only codebase analysis (uses Haiku)
- Plan: Research for planning without code changes
- general-purpose: Full capabilities for complex tasks

**Example:**
To research multiple topics in parallel:
1. Spawn subagent for topic A (run_in_background: true)
2. Spawn subagent for topic B (run_in_background: true)
3. Continue other work while they research
4. Collect results when done

**Constraints:**
- Subagents cannot spawn subagents (single level)
- Background subagents cannot ask clarifying questions
- Provide detailed context in prompts (agents start fresh)
</subagent-orchestration>`;
}
```

## Don't Hand-Roll

Problems with existing solutions in Claude Code:

| Problem                    | Don't Build                     | Use Instead                           | Why                                                                          |
| -------------------------- | ------------------------------- | ------------------------------------- | ---------------------------------------------------------------------------- |
| Agent spawning             | Custom child_process management | Task tool                             | Task tool handles context isolation, result collection, background execution |
| Multi-session coordination | Custom file locking/IPC         | CLAUDE_CODE_TASK_LIST_ID              | Native solution with real-time sync                                          |
| Agent type configuration   | Custom agent definitions        | Built-in Explore/Plan/general-purpose | Already optimized for common patterns                                        |
| Background task tracking   | Custom status files             | /tasks command + native monitoring    | Task tool maintains state automatically                                      |
| Context sharing            | Custom prompt building          | Task tool prompt parameter            | Explicit context passing built into Task invocation                          |

**Key insight:** Claude Code's orchestration is mature. The main work is configuration, not implementation.

## Common Pitfalls

### Pitfall 1: Trying to Share Context Implicitly

**What goes wrong:** Expecting subagents to "know" parent context automatically
**Why it happens:** Subagents start with fresh 200K context
**How to avoid:** Pass all needed context explicitly via Task `prompt` parameter
**Warning signs:** Subagent asks "what files?" or produces irrelevant results

### Pitfall 2: Nested Subagent Spawning

**What goes wrong:** Code expects subagents to spawn their own subagents
**Why it happens:** Mental model of recursive delegation
**How to avoid:** Design for single-level delegation only; parent coordinates all
**Warning signs:** Task tool calls failing inside subagent sessions

### Pitfall 3: Background Agent Permission Failures

**What goes wrong:** Background subagents fail on permission prompts
**Why it happens:** Background agents auto-deny any permission prompt
**How to avoid:** Use `--dangerously-skip-permissions` or pre-approve tools with `--allowedTools`
**Warning signs:** Background tasks failing with permission errors

### Pitfall 4: Context Pollution from Results

**What goes wrong:** Subagent returns full analysis, consuming parent context
**Why it happens:** Verbose subagent prompts without length guidance
**How to avoid:** Instruct subagents to "return concise summary" in prompt
**Warning signs:** Parent context filling up after subagent results

### Pitfall 5: Task List ID Collisions

**What goes wrong:** Multiple klausbot instances interfere with each other
**Why it happens:** Generic CLAUDE_CODE_TASK_LIST_ID values
**How to avoid:** Use unique IDs per klausbot instance (include timestamp or chat ID)
**Warning signs:** Tasks appearing from wrong conversations

## Code Examples

### Spawner Configuration for Subagent Support

Source: Existing spawner.ts patterns + [Official docs](https://code.claude.com/docs/en/sub-agents)

```typescript
// spawner.ts modifications
export interface SpawnerOptions {
  timeout?: number;
  model?: string;
  additionalInstructions?: string;
  enableSubagents?: boolean; // NEW: opt-in to Task tool
  taskListId?: string; // NEW: for multi-session coordination
}

export async function queryClaudeCode(
  prompt: string,
  options: SpawnerOptions = {},
): Promise<ClaudeResponse> {
  // Build args
  const args = [
    "--dangerously-skip-permissions",
    "-p",
    wrappedPrompt,
    "--output-format",
    "json",
    "--append-system-prompt",
    systemPrompt,
    "--mcp-config",
    mcpConfigPath,
    "--settings",
    settingsJson,
  ];

  // Enable Task tool if requested
  if (options.enableSubagents) {
    args.push("--allowedTools", "Task");
  }

  // Build environment
  const env = { ...process.env };
  if (options.taskListId) {
    env.CLAUDE_CODE_TASK_LIST_ID = options.taskListId;
  }

  const claude = spawn("claude", args, {
    stdio: ["inherit", "pipe", "pipe"],
    cwd: KLAUSBOT_HOME,
    env,
  });
  // ... rest of implementation
}
```

### Custom Subagent Definition

Source: [Official docs](https://code.claude.com/docs/en/sub-agents#write-subagent-files)

```markdown
## <!-- ~/.claude/agents/klausbot-researcher.md -->

name: klausbot-researcher
description: Research assistant for parallel information gathering
tools: Read, Glob, Grep, Bash, WebSearch, WebFetch
model: sonnet

---

You are a research specialist for klausbot. When invoked:

1. Focus on the specific research task provided
2. Gather comprehensive information
3. Return a concise summary (max 500 words)
4. Include sources and confidence levels

Working directory: ~/.klausbot/

Key constraints:

- Read-only operations preferred
- Return summary, not full content
- Cite sources when possible
```

### Orchestration Instructions for System Prompt

Source: Synthesized from [Official docs](https://code.claude.com/docs/en/sub-agents) + [Task tool deep dive](https://dev.to/bhaidar/the-task-tool-claude-codes-agent-orchestration-system-4bf2)

```typescript
export function getOrchestrationInstructions(): string {
  return `<subagent-orchestration>
## Spawning Subagents

You can delegate work to subagents using the Task tool.

### When to use:
- Parallel research (spawn multiple, synthesize results)
- Context isolation (keep verbose output out of main context)
- Specialized tasks (use Explore for codebase analysis)

### Task tool parameters:
- subagent_type: "Explore" | "Plan" | "general-purpose" | custom agent name
- description: Brief task description (3-5 words)
- prompt: Full instructions (include all needed context)
- run_in_background: true for async, false for blocking
- model: "haiku" (fast/cheap), "sonnet" (balanced), "opus" (capable)

### Example - parallel research:
<invoke name="Task">
  <parameter name="subagent_type">Explore</parameter>
  <parameter name="description">Analyze auth module</parameter>
  <parameter name="prompt">Search for authentication patterns in the codebase. Return: key files, patterns used, potential issues. Max 300 words.</parameter>
  <parameter name="run_in_background">true</parameter>
  <parameter name="model">haiku</parameter>
</invoke>

### Important constraints:
- Subagents start fresh (pass all context via prompt)
- Single level only (subagents cannot spawn subagents)
- Background agents cannot ask questions (provide complete instructions)
- Instruct agents to return concise summaries
</subagent-orchestration>`;
}
```

## State of the Art

| Old Approach            | Current Approach         | When Changed                    | Impact                                        |
| ----------------------- | ------------------------ | ------------------------------- | --------------------------------------------- |
| Manual process spawning | Task tool                | Claude Code 2.0 (2025)          | Built-in orchestration, no custom code needed |
| File-based coordination | CLAUDE_CODE_TASK_LIST_ID | Claude Code 2.1.16 (2026-01-22) | Native multi-session sync                     |
| Todo tracking           | Tasks system             | Claude Code 2.1.16 (2026-01-22) | Sophisticated task lifecycle management       |
| Custom agent prompts    | Agent markdown files     | Claude Code 2.0 (2025)          | Declarative agent configuration               |

**Recent developments:**

- Task tool introduced in Claude Code 2.0 (2025)
- CLAUDE_CODE_TASK_LIST_ID added in 2.1.16 (2026-01-22)
- Background agent support improved continuously
- `/tasks` command for monitoring

## Open Questions

### 1. Task List Lifecycle

- **What we know:** Task lists persist to `~/.claude/tasks/{id}/`
- **What's unclear:** Automatic cleanup of old task lists?
- **Recommendation:** Use session-scoped IDs, implement manual cleanup if needed

### 2. Concurrent Parent Sessions

- **What we know:** Multiple sessions can share a task list
- **What's unclear:** How klausbot's single-queue model interacts with concurrent Claude sessions
- **Recommendation:** Start with single parent session, expand if needed

### 3. MCP Tools in Subagents

- **What we know:** Background subagents can't use MCP tools
- **What's unclear:** Foreground subagents and MCP tool availability
- **Recommendation:** Test foreground subagent MCP access; may need to pass context via prompts instead

## Sources

### Primary (HIGH confidence)

- [Claude Code Subagents Documentation](https://code.claude.com/docs/en/sub-agents) - Complete configuration reference
- [Claude Code Headless Mode](https://code.claude.com/docs/en/headless) - CLI programmatic usage

### Secondary (MEDIUM confidence)

- [Task Tool Deep Dive](https://dev.to/bhaidar/the-task-tool-claude-codes-agent-orchestration-system-4bf2) - Detailed Task parameters
- [Async Workflows Guide](https://claudefa.st/blog/guide/agents/async-workflows) - Background agent patterns
- [Task Management System](https://claudefa.st/blog/guide/development/task-management) - CLAUDE_CODE_TASK_LIST_ID usage

### Tertiary (LOW confidence)

- [VentureBeat coverage](https://venturebeat.com/orchestration/claude-codes-tasks-update-lets-agents-work-longer-and-coordinate-across) - High-level feature overview
- Various GitHub gists - Community patterns and examples

## Metadata

**Confidence breakdown:**

- Standard stack: HIGH - Official documentation extensively covers Task tool
- Architecture: HIGH - Claude Code's model is well-documented
- Pitfalls: MEDIUM - Based on documentation warnings + community patterns

**Research date:** 2026-02-05
**Valid until:** 2026-03-05 (30 days - Claude Code updates frequently)
