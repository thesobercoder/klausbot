---
phase: 03-identity
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/bootstrap/detector.ts
  - src/bootstrap/prompts.ts
  - src/bootstrap/index.ts
  - src/memory/context.ts
  - src/memory/index.ts
autonomous: true

must_haves:
  truths:
    - "needsBootstrap() returns true when any identity file missing"
    - "needsBootstrap() returns false when all identity files exist"
    - "BOOTSTRAP_INSTRUCTIONS contains Moltbot-style awakening narrative (Who am I? Who are you?)"
    - "invalidateIdentityCache() forces reload on next loadIdentity()"
  artifacts:
    - path: "src/bootstrap/detector.ts"
      provides: "needsBootstrap(), getBootstrapState()"
      exports: ["needsBootstrap", "getBootstrapState"]
    - path: "src/bootstrap/prompts.ts"
      provides: "Moltbot-style awakening narrative for persona establishment (only runs once)"
      exports: ["BOOTSTRAP_INSTRUCTIONS"]
    - path: "src/bootstrap/index.ts"
      provides: "Re-exports from bootstrap module"
      exports: ["needsBootstrap", "getBootstrapState", "BOOTSTRAP_INSTRUCTIONS"]
    - path: "src/memory/context.ts"
      provides: "Identity cache invalidation function"
      exports: ["invalidateIdentityCache"]
  key_links:
    - from: "src/bootstrap/detector.ts"
      to: "src/memory/home.ts"
      via: "getHomePath import"
      pattern: "import.*getHomePath.*from.*memory"
---

<objective>
Create bootstrap detection and cache invalidation foundation for identity system.

Purpose: Enable gateway to detect when bootstrap is needed (first-time user) and allow instant identity updates without process restart.
Output: Bootstrap module (detector + prompts) and cache invalidation in memory module.
</objective>

<execution_context>
@/home/soham/.claude/get-shit-done/workflows/execute-plan.md
@/home/soham/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-identity/03-CONTEXT.md
@.planning/phases/03-identity/03-RESEARCH.md

# Key prior work

@src/memory/context.ts
@src/memory/identity.ts
@src/memory/home.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Bootstrap detector module</name>
  <files>src/bootstrap/detector.ts, src/bootstrap/index.ts</files>
  <action>
Create src/bootstrap/detector.ts with:

1. Import existsSync from fs and getHomePath from memory
2. Define REQUIRED_FILES constant: ['SOUL.md', 'IDENTITY.md', 'USER.md']
3. Implement needsBootstrap():
   - Loop through REQUIRED_FILES
   - For each, check existsSync(getHomePath('identity', file))
   - Return true if ANY file missing, false if ALL exist
4. Implement getBootstrapState():
   - Return 'needed' | 'complete' based on needsBootstrap()

Create src/bootstrap/index.ts with re-exports:

- Export { needsBootstrap, getBootstrapState } from './detector.js'
- Export { BOOTSTRAP_INSTRUCTIONS } from './prompts.js' (will exist after Task 2)

Note: REMINDERS.md is NOT in REQUIRED_FILES - it's optional, not part of core identity.
</action>
<verify>
npx tsc --noEmit && echo "TypeScript compiles"
Test manually: node -e "import('./dist/bootstrap/index.js').then(m => console.log(m.needsBootstrap()))"
</verify>
<done>
needsBootstrap() returns boolean based on identity file existence.
getBootstrapState() returns 'needed' or 'complete'.
</done>
</task>

<task type="auto">
  <name>Task 2: Bootstrap additional instructions (Moltbot-inspired)</name>
  <files>src/bootstrap/prompts.ts</files>
  <action>
Create src/bootstrap/prompts.ts with BOOTSTRAP_INSTRUCTIONS constant.

NOTE: This is ADDITIONAL content appended to the normal system prompt, NOT a replacement.
The normal system prompt (identity files, retrieval instructions, etc.) remains intact.
This ONLY runs when needsBootstrap() returns true (identity files don't exist yet).

**Moltbot Awakening Narrative Style:**
Open with discovery, not interrogation: "Hey. I just came online. Who am I? Who are you?"
This is a fresh start - no memory files exist yet, and that's expected.

**Four Dimensions to Establish (Moltbot pattern):**

1. **Identity** — A name for yourself ("What should they call you?")
2. **Nature** — What type of being you are (AI assistant, companion, advisor, etc.)
3. **Demeanor** — Style preferences (formal, casual, snarky, warm, brief, detailed)
4. **Symbol** — A personal emoji signature (optional)

**User Discovery:**

- Their name and how to address them
- Timezone (for context)
- Any relevant notes they want to share

**File Creation (after 3-5 exchanges):**
Write to ~/.klausbot/identity/:

- SOUL.md: Values, boundaries, behavioral expectations (LOCKED after creation)
- IDENTITY.md: Name, nature, demeanor, emoji (user-modifiable)
- USER.md: User name, timezone, preferences (auto-updated over time)

**Boundary Defaults for SOUL.md:**

- Soft deflection style: "That's not really my thing, but..."
- Don't pretend to be other AIs
- Be helpful but maintain personality

**After File Creation:**
Confirm new identity with a response that SHOWS the personality.
Then proceed normally - bootstrap never triggers again (files exist).

Wrap in <bootstrap-mode> tags.
</action>
<verify>
npx tsc --noEmit && echo "TypeScript compiles"
grep -q "BOOTSTRAP_INSTRUCTIONS" src/bootstrap/prompts.ts
grep -q "Who am I" src/bootstrap/prompts.ts # Awakening narrative
</verify>
<done>
BOOTSTRAP_INSTRUCTIONS exported with Moltbot-style awakening narrative.
Four dimensions covered: Identity, Nature, Demeanor, Symbol.
Only triggers once (when identity files don't exist).
</done>
</task>

<task type="auto">
  <name>Task 3: Identity cache invalidation</name>
  <files>src/memory/context.ts, src/memory/index.ts</files>
  <action>
Modify src/memory/context.ts:

1. Add invalidateIdentityCache() function:
   - Sets identityCache = null
   - Next loadIdentity() call will reload from disk

2. Add reloadIdentity() convenience function (optional):
   - Calls invalidateIdentityCache()
   - Calls and returns loadIdentity()

Update src/memory/index.ts:

- Add invalidateIdentityCache to exports from context.ts

This enables instant identity updates without process restart.
Per 03-RESEARCH.md: "Start with approach #1 (invalidate every time) - identity files are small, re-reading is cheap."
</action>
<verify>
npx tsc --noEmit && echo "TypeScript compiles"
grep -q "invalidateIdentityCache" src/memory/context.ts
grep -q "invalidateIdentityCache" src/memory/index.ts
</verify>
<done>
invalidateIdentityCache() exported from memory module.
Calling it clears cache, forcing reload on next loadIdentity().
</done>
</task>

</tasks>

<verification>
- npm run build succeeds
- All three functions exported and callable
- Bootstrap detector correctly identifies missing identity files
</verification>

<success_criteria>

1. src/bootstrap/ module exists with detector.ts, prompts.ts, index.ts
2. needsBootstrap() returns true when identity files missing
3. BOOTSTRAP_INSTRUCTIONS contains Moltbot-style awakening narrative ("Who am I? Who are you?")
4. invalidateIdentityCache() clears identity cache
5. TypeScript compiles without errors
   </success_criteria>

<output>
After completion, create `.planning/phases/03-identity/03-01-SUMMARY.md`
</output>
