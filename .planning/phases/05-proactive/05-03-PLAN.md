---
phase: 05-proactive
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - src/daemon/gateway.ts
  - src/memory/home.ts
  - src/telegram/commands.ts
autonomous: true

must_haves:
  truths:
    - "Cron scheduler starts when gateway starts"
    - "Cron scheduler stops when gateway stops"
    - "/crons command lists scheduled tasks"
    - "Missed jobs recovered on startup (if < 24h old)"
    - "~/.klausbot/cron/ directory created on startup"
  artifacts:
    - path: "src/daemon/gateway.ts"
      provides: "Gateway integration with cron system"
      contains: "startScheduler"
    - path: "src/memory/home.ts"
      provides: "cron directory in DIRS"
      contains: "'cron'"
    - path: "src/telegram/commands.ts"
      provides: "/crons command handler"
      contains: "bot.command('crons'"
  key_links:
    - from: "src/daemon/gateway.ts"
      to: "src/cron/scheduler.ts"
      via: "imports and calls startScheduler/stopScheduler"
      pattern: "import.*startScheduler.*from.*cron"
    - from: "src/telegram/commands.ts"
      to: "src/cron/service.ts"
      via: "imports listCronJobs"
      pattern: "import.*listCronJobs.*from.*cron"
---

<objective>
Integrate cron system with gateway and add /crons Telegram command.

Purpose: Complete cron system by wiring scheduler to gateway lifecycle and providing job visibility.
Output: Working end-to-end cron system with Telegram command.
</objective>

<execution_context>
@/home/soham/.claude/get-shit-done/workflows/execute-plan.md
@/home/soham/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-proactive/05-RESEARCH.md
@.planning/phases/05-proactive/05-01-SUMMARY.md
@.planning/phases/05-proactive/05-02-SUMMARY.md

Reference files:
@src/daemon/gateway.ts
@src/memory/home.ts
@src/telegram/commands.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add cron directory and gateway integration</name>
  <files>src/memory/home.ts, src/daemon/gateway.ts</files>
  <action>
Update src/memory/home.ts:
- Add 'cron' to DIRS array: ['config', 'conversations', 'identity', 'cron']

Update src/daemon/gateway.ts startGateway():

1. Add import: import { startScheduler, stopScheduler, recoverMissedJobs, loadCronStore } from '../cron/index.js';
2. After initializeHome(), before "Auto-install skill-creator":
   ```typescript
   // Initialize cron system
   recoverMissedJobs();
   startScheduler();
   log.info(
     { jobs: loadCronStore().jobs.filter((j) => j.enabled).length },
     "Cron scheduler initialized",
   );
   ```

Update src/daemon/gateway.ts stopGateway():

1. Before "Wait for current processing to finish":
   ```typescript
   stopScheduler();
   ```
     </action>
     <verify>
   npm run build
   grep -n "startScheduler" src/daemon/gateway.ts
   grep -n "'cron'" src/memory/home.ts
     </verify>
     <done>
   ~/.klausbot/cron/ directory created on startup.
   Scheduler starts/stops with gateway lifecycle.
     </done>
   </task>

<task type="auto">
  <name>Task 2: Add /crons Telegram command</name>
  <files>src/telegram/commands.ts, src/daemon/gateway.ts</files>
  <action>
Update src/telegram/commands.ts:
1. Add import: import { listCronJobs } from '../cron/index.js';
2. Add /crons command handler after /help:

```typescript
// /crons - list scheduled tasks
bot.command("crons", async (ctx: MyContext) => {
  const chatId = ctx.chat?.id;
  if (!chatId) return;

  log.info({ chatId }, "/crons command invoked");

  const jobs = listCronJobs(chatId);
  const enabledJobs = jobs.filter((j) => j.enabled);

  if (enabledJobs.length === 0) {
    await ctx.reply(
      'No scheduled tasks.\n\nCreate one with natural language, e.g.:\n"Remind me every morning at 9am to check emails"',
    );
    return;
  }

  const lines = enabledJobs.map((job) => {
    const nextRun = job.nextRunAtMs
      ? new Date(job.nextRunAtMs).toLocaleString()
      : "never";
    const status = job.lastStatus ? ` (last: ${job.lastStatus})` : "";
    return `- *${job.name}*: ${job.humanSchedule}\n  Next: ${nextRun}${status}`;
  });

  await ctx.reply(
    `*Scheduled Tasks*\n\n${lines.join("\n\n")}\n\n_Modify or delete via conversation_`,
    { parse_mode: "Markdown" },
  );
});
```

3. Update log.info at end to include 'crons': 'Commands registered: /start, /model, /status, /help, /crons'

Also add /crons to gateway.ts /help command output:

- Add line: '/crons - List scheduled tasks'
  </action>
  <verify>
  npm run build
  grep -n "/crons" src/telegram/commands.ts
  grep -n "crons" src/daemon/gateway.ts
  </verify>
  <done>
  /crons command lists user's scheduled tasks with next run times.
  /help includes /crons in command list.
  </done>
  </task>

</tasks>

<verification>
1. npm run build succeeds
2. Gateway starts scheduler on startup (check logs)
3. /crons command responds with job list or empty message
4. ~/.klausbot/cron/ directory created
5. Gateway stops scheduler on shutdown
</verification>

<success_criteria>

- Cron scheduler integrated with gateway lifecycle
- /crons command shows scheduled tasks with next run times
- Empty state shows helpful creation instructions
- /help includes /crons command
  </success_criteria>

<output>
After completion, create `.planning/phases/05-proactive/05-03-SUMMARY.md`
</output>
