---
phase: 05.1-mcp-cron
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/mcp-server/index.ts
  - src/mcp-server/tools/cron.ts
  - src/cron/parse.ts
autonomous: true

must_haves:
  truths:
    - "MCP server starts via stdio transport without errors"
    - "create_cron tool validates input and creates job in store"
    - "list_crons tool returns jobs filtered by chatId"
    - "delete_cron tool removes job from store"
  artifacts:
    - path: "src/mcp-server/index.ts"
      provides: "MCP server entry point with stdio transport"
      min_lines: 20
    - path: "src/mcp-server/tools/cron.ts"
      provides: "Three cron tools: create, list, delete"
      exports: ["registerCronTools"]
  key_links:
    - from: "src/mcp-server/tools/cron.ts"
      to: "src/cron/service.ts"
      via: "imports createCronJob, listCronJobs, deleteCronJob"
      pattern: "import.*from.*cron/service"
    - from: "src/mcp-server/index.ts"
      to: "src/mcp-server/tools/cron.ts"
      via: "registerCronTools call"
      pattern: "registerCronTools"
---

<objective>
Create standalone MCP server exposing cron tools via stdio transport.

Purpose: Enable Claude to manage cron jobs through typed MCP tools instead of CLI commands.
Output: Working MCP server binary (`src/mcp-server/index.ts`) with three cron tools.
</objective>

<execution_context>
@/home/soham/.claude/get-shit-done/workflows/execute-plan.md
@/home/soham/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05.1-mcp-cron/05.1-RESEARCH.md
@src/cron/service.ts
@src/cron/types.ts
@src/cron/parse.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install MCP SDK and create server entry point</name>
  <files>package.json, src/mcp-server/index.ts</files>
  <action>
    1. Install @modelcontextprotocol/sdk:
       ```bash
       npm install @modelcontextprotocol/sdk
       ```

    2. Create src/mcp-server/index.ts with:
       - Import McpServer from "@modelcontextprotocol/sdk/server/mcp.js"
       - Import StdioServerTransport from "@modelcontextprotocol/sdk/server/stdio.js"
       - Create server instance: `new McpServer({ name: "klausbot", version: "1.0.0" })`
       - Import and call registerCronTools(server) (will be created in Task 2)
       - Create transport: `new StdioServerTransport()`
       - Connect: `await server.connect(transport)`
       - Use top-level await (ES modules support it)

    Note: Server runs as subprocess spawned by Claude CLI. No HTTP needed.

  </action>
  <verify>
    - npm install succeeds
    - File exists at src/mcp-server/index.ts
    - TypeScript compiles without errors: `npx tsc --noEmit`
  </verify>
  <done>MCP server entry point created with stdio transport setup</done>
</task>

<task type="auto">
  <name>Task 2: Create cron tools module with create, list, delete</name>
  <files>src/mcp-server/tools/cron.ts, src/cron/parse.ts</files>
  <action>
    1. Create src/mcp-server/tools/cron.ts with registerCronTools function:

    2. **create_cron tool:**
       - Parameters (via zod):
         - name: z.string().describe("Job name")
         - schedule: z.string().describe("Schedule: cron expression or natural language like 'every day at 9am'")
         - instruction: z.string().describe("What Claude should do when job runs")
         - chatId: z.number().describe("Telegram chat ID for notifications")
       - Implementation:
         - Call parseSchedule(schedule) from src/cron/parse.ts to convert string to CronSchedule
         - Call createCronJob() from src/cron/service.ts
         - Return success message with job ID and next run time
       - Handle parse errors gracefully (return error content, don't throw)

    3. **list_crons tool:**
       - Parameters:
         - chatId: z.number().describe("Telegram chat ID to filter jobs")
       - Implementation:
         - Call listCronJobs(chatId) from src/cron/service.ts
         - Format jobs as readable list: name, humanSchedule, next run, last status
         - Return "No scheduled tasks" if empty

    4. **delete_cron tool:**
       - Parameters:
         - id: z.string().describe("Job ID to delete (UUID)")
       - Implementation:
         - Call deleteCronJob(id) from src/cron/service.ts
         - Return success/failure message

    5. Export parseSchedule from src/cron/parse.ts if not already exported.
       The function already exists - just ensure it's in the module's public API.

  </action>
  <verify>
    - File exists at src/mcp-server/tools/cron.ts
    - TypeScript compiles: `npx tsc --noEmit`
    - parseSchedule is exported from src/cron/parse.ts
  </verify>
  <done>Three cron MCP tools created: create_cron, list_crons, delete_cron</done>
</task>

<task type="auto">
  <name>Task 3: Add MCP server build entry point</name>
  <files>tsup.config.ts (or package.json scripts)</files>
  <action>
    1. Ensure tsup builds the MCP server as a separate entry point.
       Check existing tsup config - likely builds src/index.ts.

    2. Add src/mcp-server/index.ts as additional entry:
       - If tsup.config.ts exists: add to entry array
       - If no config: tsup supports multiple entries via CLI

    3. Verify build outputs dist/mcp-server/index.js (or similar)

    4. Test the MCP server can be invoked:
       ```bash
       npm run build
       echo '{"jsonrpc":"2.0","method":"initialize","params":{"protocolVersion":"2024-11-05","capabilities":{},"clientInfo":{"name":"test"}},"id":1}' | node dist/mcp-server/index.js
       ```
       Should receive JSON-RPC response (or at least not crash immediately).

    Note: Full MCP handshake requires proper protocol messages. Basic test confirms server starts.

  </action>
  <verify>
    - `npm run build` succeeds
    - dist/mcp-server/index.js exists
    - Server process starts without immediate crash
  </verify>
  <done>MCP server builds as standalone entry point</done>
</task>

</tasks>

<verification>
1. MCP SDK installed in package.json dependencies
2. src/mcp-server/index.ts creates server with stdio transport
3. src/mcp-server/tools/cron.ts exports registerCronTools
4. Three tools defined: create_cron, list_crons, delete_cron
5. Build produces dist/mcp-server/index.js
6. TypeScript compiles without errors
</verification>

<success_criteria>

- MCP server binary exists and starts without errors
- Tools use existing cron service functions (no duplication)
- Build step produces working output
- Ready for spawner integration in Plan 02
  </success_criteria>

<output>
After completion, create `.planning/phases/05.1-mcp-cron/05.1-01-SUMMARY.md`
</output>
