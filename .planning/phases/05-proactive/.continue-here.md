---
phase: 05-proactive
task: UAT (05-05)
total_tasks: 5
status: blocked_on_architecture_decision
last_updated: 2026-01-30T08:20:00Z
---

<current_state>
Phase 5 plans 01-04 executed successfully. Plan 05-05 (human verification) in progress.

During UAT, discovered fundamental architecture flaw: Claude cannot call TypeScript functions directly — it runs as a subprocess via `claude` CLI and can only edit files or run bash commands.

Quick fix applied (cron CLI), but user correctly identified this as a bad pattern. Regex-parsing natural language to construct CLI commands is fragile.

**Architecture decision pending:** Adopt MCP or ACP for proper structured tools.
</current_state>

<completed_work>
- Plan 05-01: Cron foundation (types, store, parse, schedule) - DONE
- Plan 05-02: Cron execution (executor, service, scheduler) - DONE
- Plan 05-03: Gateway integration (/crons, lifecycle) - DONE
- Plan 05-04: Learning system (LEARNINGS.md, proactive suggestions) - DONE
- Plan 05-05: UAT - PARTIAL
  - Build verification: PASSED
  - Cron creation: WORKING (via CLI hack)
  - Cron execution: NOT FULLY TESTED (chatId fix applied)
</completed_work>

<remaining_work>
- Plan 05-05: Complete UAT after architecture decision
- Architecture work: Implement MCP server for proper tool exposure

**Phase 5 is functionally complete but architecturally unsound.**
</remaining_work>

<decisions_made>
- 05-01: Three schedule kinds (at/every/cron) for comprehensive coverage
- 05-01: croner + chrono-node for schedule parsing
- 05-02: Sequential job execution, retry once after 60s
- 05-03: Scheduler starts/stops with gateway lifecycle
- 05-04: LEARNINGS.md agentic (read when relevant, not preloaded)

**Session decisions:**
- Added chatId to session-context for cron management
- Created cron CLI as workaround (klausbot cron add/list/delete)
- Added recurring schedule patterns (every day at 3pm -> cron expr)
</decisions_made>

<blockers>
- **Architecture blocker:** Current approach has Claude parsing natural language → guessing CLI args → CLI parsing schedule strings. Multiple failure points, no type safety.
- **User feedback:** "This is the worst logic ever" — and they're right.
- **Proposed solution:** Adopt MCP (Model Context Protocol) for structured tools. Claude Code has native support.
</blockers>

<context>
User suggested adopting Agent Client Protocol (ACP) or MCP for proper tool exposure.

MCP seems more natural since Claude Code already supports it. Would need to:
1. Create klausbot-mcp-server that exposes cron/memory tools
2. Configure Claude Code to use it
3. Remove the CLI workaround

This is a significant architectural change that affects how Claude interacts with klausbot. Should probably be a new phase or inserted phase.

The current cron system WORKS but is fragile. The core scheduling/execution logic is solid — just the interface to Claude is wrong.
</context>

<next_action>
When resuming:

1. Decide on MCP vs ACP (recommend MCP for Claude Code native support)
2. Either:
   a. Insert new phase for MCP implementation, OR
   b. Add MCP to Phase 7 (Resilience & Tooling), OR
   c. Complete Phase 5 UAT as-is, add MCP as future work

User was about to provide direction on which approach to take.
</next_action>
